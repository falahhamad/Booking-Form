<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>استمارة التخرج - الإصدار النهائي</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- الخطوط والأيقونات -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #f8fafc;
        }

        /* --- تصميم بطاقات الخيارات --- */
        .option-card {
            cursor: pointer;
            border: 1.5px solid #e2e8f0;
            border-radius: 1rem;
            padding: 0.75rem;
            font-size: 0.9rem;
            transition: all 0.2s ease-in-out;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            background-color: white;
            min-height: 70px;
            font-weight: 500;
            color: #475569;
            position: relative;
        }

        .option-card:hover {
            border-color: #94a3b8;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        /* حالات التفعيل */
        .option-card.active-purple { background-color: #f3e8ff; border-color: #9333ea; color: #6b21a8; box-shadow: 0 0 0 1px #9333ea; }
        .option-card.active-indigo { background-color: #e0e7ff; border-color: #4f46e5; color: #3730a3; box-shadow: 0 0 0 1px #4f46e5; }
        .option-card.active-emerald { background-color: #d1fae5; border-color: #059669; color: #065f46; box-shadow: 0 0 0 1px #059669; }
        .option-card.active-gray { background-color: #f3f4f6; border-color: #6b7280; color: #374151; }

        /* --- مربعات رفع الصور --- */
        .upload-container-wrapper {
            width: 100%;
            max-width: 200px;
            margin: 0 auto;
        }

        .upload-box {
            width: 100%;
            aspect-ratio: 1 / 1;
            border: 2px dashed #cbd5e1;
            border-radius: 0.75rem;
            position: relative;
            background-color: #f8fafc;
            transition: all 0.3s ease;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .upload-box:hover {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }

        .upload-box.has-image {
            border-style: solid;
            border-color: #e2e8f0;
            background-color: #fff;
        }

        .upload-placeholder {
            text-align: center;
            color: #94a3b8;
            pointer-events: none;
            padding: 1rem;
        }
        
        .uploaded-img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
        }

        /* أزرار التحكم بالصورة */
        .img-actions {
            position: absolute;
            top: 5px;
            right: 5px;
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 10;
        }
        .upload-box:hover .img-actions { opacity: 1; }

        .action-btn {
            width: 24px; height: 24px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.7rem; color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            border: none; cursor: pointer;
        }

        .custom-input { transition: all 0.2s; }
        .hidden { display: none !important; }
        
        /* شاشة التحميل */
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95);
            z-index: 9999;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        .loader {
            border: 5px solid #f3f3f3; border-top: 5px solid #3b82f6;
            border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        @media print { .no-print { display: none !important; } }
    </style>
</head>
<body class="min-h-screen pb-24">

    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <div class="loader"></div>
        <h3 class="text-xl font-bold text-gray-800">جاري تجهيز وإرسال الاستمارة...</h3>
    </div>

    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-40 no-print border-b border-gray-100">
        <div class="max-w-4xl mx-auto px-4 py-3 flex flex-col md:flex-row justify-between items-center gap-3">
            <h1 class="text-lg font-bold text-gray-800">استمارة التخرج الإلكترونية</h1>
            <div class="w-full md:w-1/2 flex flex-col items-center">
                <div class="w-full bg-gray-100 rounded-full h-3 overflow-hidden shadow-inner">
                    <div id="progress-bar" class="bg-gradient-to-l from-blue-500 to-blue-600 h-3 rounded-full transition-all duration-700 ease-out" style="width: 0%"></div>
                </div>
                <span id="progress-text" class="text-xs font-bold text-blue-600 mt-1">جاري البدء...</span>
            </div>
        </div>
    </header>

    <!-- Main Form Container -->
    <main id="main-form-container" class="max-w-4xl mx-auto mt-6 px-4 space-y-6">
        <form id="gradForm" onsubmit="return false;">

            <!-- 1. Info Section -->
            <section class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 relative overflow-hidden">
                <div class="absolute top-0 right-0 w-1.5 h-full bg-blue-500"></div>
                <h2 class="text-xl font-bold mb-4 text-gray-800 flex items-center gap-2">
                    <i class="fas fa-user-graduate text-blue-500"></i> قسم المعلومات
                </h2>
                <div class="w-full">
                    <label class="block text-gray-700 font-bold mb-2 text-sm">الاسم الرباعي</label>
                    <input type="text" name="fullName" id="input-fullName" class="custom-input w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none bg-gray-50" placeholder="ادخل هنا الاسم الرباعي" required oninput="updateProgress()">
                </div>
            </section>

            <!-- 2. Sash Section -->
            <section class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 relative overflow-hidden">
                <div class="absolute top-0 right-0 w-1.5 h-full bg-purple-500"></div>
                <h2 class="text-xl font-bold mb-4 text-gray-800 flex items-center gap-2">
                    <i class="fas fa-ribbon text-purple-500"></i> أولاً: الوشاح
                </h2>

                <div class="mb-6">
                    <label class="block text-gray-700 font-bold mb-3 text-sm">اختيار نوع الوشاح</label>
                    <input type="hidden" id="sashType" name="sashType" onchange="handleSashChange()">
                    
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 card-grid">
                        <div class="option-card hover:bg-purple-50" onclick="selectOption('sashType', 'عادي', this, 'purple')">عادي</div>
                        <div class="option-card hover:bg-purple-50" onclick="selectOption('sashType', 'مثلث', this, 'purple')">مثلث</div>
                        <div class="option-card hover:bg-purple-50" onclick="selectOption('sashType', 'ملكي فرعوني', this, 'purple')">ملكي فرعوني</div>
                        <div class="option-card hover:bg-purple-50" onclick="selectOption('sashType', 'ملكي مثلث', this, 'purple')">ملكي مثلث</div>
                        <div class="option-card hover:bg-purple-50" onclick="selectOption('sashType', 'جانبي', this, 'purple')">جانبي</div>
                        <div class="option-card hover:bg-purple-50" onclick="selectOption('sashType', 'امريكي + عادي', this, 'purple')">امريكي + عادي</div>
                        <div class="option-card hover:bg-purple-50" onclick="selectOption('sashType', 'امريكي + مثلث', this, 'purple')">امريكي + مثلث</div>
                        <div class="option-card hover:bg-purple-50" onclick="selectOption('sashType', 'امريكي + ملكي فرعوني', this, 'purple')">امريكي + ملكي فرعوني</div>
                        <div class="option-card hover:bg-purple-50" onclick="selectOption('sashType', 'امريكي + ملكي مثلث', this, 'purple')">امريكي + ملكي مثلث</div>
                        <div class="option-card hover:bg-purple-50" onclick="selectOption('sashType', 'امريكي + جانبي', this, 'purple')">امريكي + جانبي</div>
                        <div class="option-card hover:bg-red-50 col-span-2 sm:col-span-2" onclick="selectOption('sashType', 'لا اريد وشاح', this, 'gray')">
                            <span class="text-red-500 font-bold">لا اريد وشاح</span>
                        </div>
                    </div>
                </div>

                <div id="sashContentWrapper" class="hidden transition-all">
                    <div id="sashSectionTwoSides" class="mb-6 bg-gray-50 p-4 rounded-xl border border-gray-200 hidden">
                        <h3 class="font-bold text-sm text-purple-700 mb-4 border-b pb-2 border-purple-100">1. النقش من الامام (الوشاح ذو الجانبين)</h3>
                        <div class="grid grid-cols-2 gap-4 justify-items-center">
                            <div class="upload-container-wrapper">
                                <label class="block text-xs text-gray-500 mb-1 text-center">الجهة اليمنى</label>
                                <div id="upload-sash-right"></div>
                            </div>
                            <div class="upload-container-wrapper">
                                <label class="block text-xs text-gray-500 mb-1 text-center">الجهة اليسرى</label>
                                <div id="upload-sash-left"></div>
                            </div>
                        </div>
                    </div>

                    <div id="sashSectionOneSide" class="mb-6 bg-gray-50 p-4 rounded-xl border border-gray-200 hidden">
                         <h3 class="font-bold text-sm text-purple-700 mb-4 border-b pb-2 border-purple-100">1. النقش من الامام (الوشاح الجانبي)</h3>
                         <div class="flex justify-center">
                            <div class="upload-container-wrapper">
                                <label class="block text-xs text-gray-500 mb-1 text-center">النقش على الوشاح</label>
                                <div id="upload-sash-side-1"></div>
                            </div>
                        </div>
                    </div>

                    <div id="sashSectionBack" class="mb-6 bg-gray-50 p-4 rounded-xl border border-gray-200 hidden">
                        <h3 class="font-bold text-sm text-purple-700 mb-4 border-b pb-2 border-purple-100">2. النقش من الخلف (خاص بالوشاح الملكي)</h3>
                         <div class="grid grid-cols-2 gap-4 justify-items-center">
                            <div class="upload-container-wrapper">
                                <div id="upload-sash-back-1"></div>
                            </div>
                            <div class="upload-container-wrapper">
                                <div id="upload-sash-back-2"></div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 pt-4 border-t border-gray-100">
                        <div>
                            <label class="block text-gray-600 text-sm font-bold mb-1">لون الوشاح</label>
                            <input type="text" name="sashColor" class="custom-input w-full p-2 border border-gray-300 rounded-lg text-sm" placeholder="مثلا ماروني...">
                        </div>
                         <div>
                            <label class="block text-gray-600 text-sm font-bold mb-1">لون الكركوشة</label>
                            <input type="text" name="sashTasselColor" class="custom-input w-full p-2 border border-gray-300 rounded-lg text-sm" placeholder="مثلا اخضر او ابيض...">
                        </div>
                         <div>
                            <label class="block text-gray-600 text-sm font-bold mb-1">لون النقش</label>
                            <input type="text" name="sashEmbroideryColor" class="custom-input w-full p-2 border border-gray-300 rounded-lg text-sm" placeholder="مثلا ابيض او فضي...">
                        </div>
                        
                        <div class="md:col-span-3 grid grid-cols-1 md:grid-cols-3 gap-4 mt-2 bg-gray-50 p-4 rounded-xl border border-purple-100">
                            <div class="md:col-span-2">
                                <label class="block text-purple-700 text-sm font-bold mb-2">ملاحظات إضافية</label>
                                <textarea name="sashNotes" class="custom-input w-full p-3 border border-gray-300 rounded-xl text-sm resize-none shadow-sm focus:border-purple-400" rows="7" placeholder="اكتب أي ملاحظات أو تفاصيل إضافية هنا..."></textarea>
                            </div>
                            <div class="flex flex-col items-center">
                                <label class="block text-purple-700 text-xs font-bold mb-2 text-center">صورة مع الملاحظة (اختياري)</label>
                                <div class="upload-container-wrapper">
                                    <div id="upload-sash-notes"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 3. Cap Section -->
            <section class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 relative overflow-hidden">
                <div class="absolute top-0 right-0 w-1.5 h-full bg-indigo-500"></div>
                <h2 class="text-xl font-bold mb-4 text-gray-800 flex items-center gap-2">
                    <i class="fas fa-graduation-cap text-indigo-500"></i> ثانياً: القبعة
                </h2>

                <div class="mb-6">
                    <label class="block text-gray-700 font-bold mb-3 text-sm">اختيار نوع القبعة</label>
                    <input type="hidden" id="capType" name="capType" onchange="handleCapTypeChange()">

                    <div class="grid grid-cols-2 md:grid-cols-3 gap-3 card-grid">
                        <div class="option-card hover:bg-indigo-50" onclick="selectOption('capType', 'قبعة عادية', this, 'indigo')">قبعة عادية</div>
                        <div class="option-card hover:bg-indigo-50" onclick="selectOption('capType', 'قبعة ملكية', this, 'indigo')">قبعة ملكية</div>
                        <div class="option-card hover:bg-red-50" onclick="selectOption('capType', 'لا اريد قبعة', this, 'gray')">
                            <span class="text-red-500 font-bold">لا اريد قبعة</span>
                        </div>
                    </div>
                </div>

                <div id="capContentWrapper" class="hidden transition-all">
                    <div class="mb-6">
                        <label class="block text-gray-700 font-bold mb-3 text-sm">مكان النقش على القبعة</label>
                        <input type="hidden" id="capEmbroideryLoc" name="capEmbroideryLoc" onchange="handleCapEmbroideryChange()">

                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 card-grid">
                            <div class="option-card hover:bg-indigo-50" onclick="selectOption('capEmbroideryLoc', 'فوق القبعة', this, 'indigo')">فوق القبعة</div>
                            <div class="option-card hover:bg-indigo-50" onclick="selectOption('capEmbroideryLoc', 'طوق القبعة', this, 'indigo')">طوق القبعة</div>
                            <div class="option-card hover:bg-indigo-50" onclick="selectOption('capEmbroideryLoc', 'دبل نقش', this, 'indigo')">دبل نقش</div>
                            <div class="option-card hover:bg-red-50" onclick="selectOption('capEmbroideryLoc', 'لا اريد نقش', this, 'gray')">لا اريد نقش</div>
                        </div>
                    </div>

                    <div class="flex flex-col md:flex-row gap-4 justify-center">
                        <div id="capSectionTop" class="hidden w-full md:w-1/2 bg-indigo-50 p-3 rounded-lg border border-indigo-100">
                            <h3 class="font-bold text-xs text-indigo-800 mb-2 text-center">1. النقش فوق القبعة</h3>
                            <div class="upload-container-wrapper">
                                <div id="upload-cap-top"></div>
                            </div>
                        </div>

                        <div id="capSectionRim" class="hidden w-full md:w-1/2 bg-indigo-50 p-3 rounded-lg border border-indigo-100">
                            <h3 class="font-bold text-xs text-indigo-800 mb-2 text-center">2. النقش على طوق القبعة</h3>
                            <div class="upload-container-wrapper">
                                <div id="upload-cap-rim"></div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4 pt-4 border-t border-gray-100">
                        <div>
                            <label class="block text-gray-600 text-sm font-bold mb-1">لون القبعة</label>
                            <input type="text" name="capColor" class="custom-input w-full p-2 border border-gray-300 rounded-lg text-sm" placeholder="مثلا اسود...">
                        </div>
                        <div id="capEmbroideryColorField">
                            <label class="block text-gray-600 text-sm font-bold mb-1">لون النقش</label>
                            <input type="text" name="capEmbroideryColor" class="custom-input w-full p-2 border border-gray-300 rounded-lg text-sm" placeholder="مثلا ابيض...">
                        </div>
                         <div>
                            <label class="block text-gray-600 text-sm font-bold mb-1">لون الكركوشة</label>
                            <input type="text" name="capTasselColor" class="custom-input w-full p-2 border border-gray-300 rounded-lg text-sm" placeholder="مثلا اخضر...">
                        </div>
                        
                        <div class="md:col-span-3 grid grid-cols-1 md:grid-cols-3 gap-4 mt-2 bg-gray-50 p-4 rounded-xl border border-indigo-100">
                            <div class="md:col-span-2">
                                <label class="block text-indigo-700 text-sm font-bold mb-2">ملاحظات إضافية</label>
                                <textarea name="capNotes" class="custom-input w-full p-3 border border-gray-300 rounded-xl text-sm resize-none shadow-sm focus:border-indigo-400" rows="7" placeholder="اكتب أي ملاحظات أو تفاصيل إضافية هنا..."></textarea>
                            </div>
                            <div class="flex flex-col items-center">
                                <label class="block text-indigo-700 text-xs font-bold mb-2 text-center">صورة مع الملاحظة (اختياري)</label>
                                <div class="upload-container-wrapper">
                                    <div id="upload-cap-notes"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 4. Gown Section -->
            <section class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 relative overflow-hidden">
                 <div class="absolute top-0 right-0 w-1.5 h-full bg-emerald-500"></div>
                <h2 class="text-xl font-bold mb-4 text-gray-800 flex items-center gap-2">
                    <i class="fas fa-tshirt text-emerald-500"></i> ثالثاً: الروب
                </h2>

                <div class="mb-6">
                    <label class="block text-gray-700 font-bold mb-3 text-sm">نوع الروب</label>
                    <input type="hidden" id="gownType" name="gownType" onchange="handleGownChange()">
                    
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-3 card-grid">
                        <div class="option-card hover:bg-emerald-50" onclick="selectOption('gownType', 'روب خليجي', this, 'emerald')">روب خليجي</div>
                        <div class="option-card hover:bg-emerald-50" onclick="selectOption('gownType', 'روب امريكي', this, 'emerald')">روب امريكي</div>
                        <div class="option-card hover:bg-red-50" onclick="selectOption('gownType', 'لا اريد روب', this, 'gray')">
                            <span class="text-red-500 font-bold">لا اريد روب</span>
                        </div>
                    </div>
                </div>

                <div id="gownContentWrapper" class="hidden transition-all">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-600 text-sm font-bold mb-1">لون الروب</label>
                            <input type="text" name="gownColor" class="custom-input w-full p-2 border border-gray-300 rounded-lg text-sm" placeholder="مثلا اسود...">
                        </div>
                    </div>
                    
                     <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4 bg-gray-50 p-4 rounded-xl border border-emerald-100">
                        <div class="md:col-span-2">
                            <label class="block text-emerald-700 text-sm font-bold mb-2">ملاحظات إضافية</label>
                            <textarea name="gownNotes" class="custom-input w-full p-3 border border-gray-300 rounded-xl text-sm resize-none shadow-sm focus:border-emerald-400" rows="7" placeholder="اكتب أي ملاحظات أو تفاصيل إضافية هنا..."></textarea>
                        </div>
                        <div class="flex flex-col items-center">
                            <label class="block text-emerald-700 text-xs font-bold mb-2 text-center">صورة مع الملاحظة (اختياري)</label>
                            <div class="upload-container-wrapper">
                                <div id="upload-gown-notes"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

        </form>
    </main>

    <!-- زر الإرسال العائم -->
    <div class="fixed bottom-6 left-6 z-50 flex flex-col gap-3 no-print">
        <button onclick="processAndSend()" class="p-4 bg-green-600 text-white rounded-full shadow-xl hover:bg-green-700 transition transform hover:scale-105 flex items-center justify-center gap-2 font-bold text-sm ring-4 ring-green-200 group">
            <span class="group-hover:animate-pulse"><i class="fas fa-paper-plane text-lg ml-2"></i></span>
            إرسال واعتماد الطلب
        </button>
    </div>

    <script>
        // ==================================================================
        // ضع رابط سكربت جوجل شيت هنا
        // ==================================================================
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyG5tdDdvBIjKHT7qDA_uZEjTUf83jwMvFRaiU869BbZY-1IvDankYLTWtCBkRP-Ce8DA/exec"; 
        // ==================================================================

        const uploadIDs = [
            'upload-sash-right', 'upload-sash-left', 'upload-sash-back-1', 'upload-sash-back-2',
            'upload-sash-side-1', 'upload-sash-notes', 
            'upload-cap-top', 'upload-cap-rim', 'upload-cap-notes', 
            'upload-gown-notes'
        ];
        
        const imageStore = {};

        document.addEventListener('DOMContentLoaded', () => {
            initUploadBoxes();
            updateProgress();
        });

        // -----------------------------------------------------------
        // Functions (Selection, Logic, Upload) - Same as before
        // -----------------------------------------------------------
        function selectOption(inputId, value, element, theme) {
            const input = document.getElementById(inputId);
            input.value = value;
            const parent = element.parentElement;
            parent.querySelectorAll('.option-card').forEach(c => {
                c.classList.remove('active-purple', 'active-indigo', 'active-emerald', 'active-gray');
            });
            element.classList.add(`active-${theme}`);
            input.dispatchEvent(new Event('change'));
            updateProgress();
        }

        function handleSashChange() {
            const val = document.getElementById('sashType').value;
            const wrapper = document.getElementById('sashContentWrapper');
            if (!val || val.includes('لا اريد')) { wrapper.classList.add('hidden'); updateProgress(); return; }
            wrapper.classList.remove('hidden');
            if (val.includes('جانبي')) {
                document.getElementById('sashSectionTwoSides').classList.add('hidden');
                document.getElementById('sashSectionOneSide').classList.remove('hidden');
            } else {
                document.getElementById('sashSectionTwoSides').classList.remove('hidden');
                document.getElementById('sashSectionOneSide').classList.add('hidden');
            }
            if (val.includes('ملكي')) {
                document.getElementById('sashSectionBack').classList.remove('hidden');
            } else {
                document.getElementById('sashSectionBack').classList.add('hidden');
            }
            updateProgress();
        }

        function handleCapTypeChange() {
            const val = document.getElementById('capType').value;
            const wrapper = document.getElementById('capContentWrapper');
            val && !val.includes('لا اريد') ? wrapper.classList.remove('hidden') : wrapper.classList.add('hidden');
            updateProgress();
        }

        function handleCapEmbroideryChange() {
            const loc = document.getElementById('capEmbroideryLoc').value;
            const top = document.getElementById('capSectionTop');
            const rim = document.getElementById('capSectionRim');
            const colorField = document.getElementById('capEmbroideryColorField');
            top.classList.add('hidden'); rim.classList.add('hidden'); colorField.classList.remove('hidden');
            if (loc === 'فوق القبعة') top.classList.remove('hidden');
            else if (loc === 'طوق القبعة') rim.classList.remove('hidden');
            else if (loc.includes('دبل')) { top.classList.remove('hidden'); rim.classList.remove('hidden'); }
            else if (loc.includes('لا اريد')) colorField.classList.add('hidden');
        }

        function handleGownChange() {
            const val = document.getElementById('gownType').value;
            const wrapper = document.getElementById('gownContentWrapper');
            val && !val.includes('لا اريد') ? wrapper.classList.remove('hidden') : wrapper.classList.add('hidden');
            updateProgress();
        }

        function initUploadBoxes() {
            uploadIDs.forEach(id => {
                const container = document.getElementById(id);
                if(container && !container.querySelector('.upload-box')) renderEmptyBox(id);
            });
        }

        function renderEmptyBox(id) {
            const container = document.getElementById(id);
            container.innerHTML = `
                <div class="upload-box group" onclick="document.getElementById('file-${id}').click()">
                    <input type="file" id="file-${id}" class="hidden" accept="image/*" onchange="processFile(event, '${id}')">
                    <div class="upload-placeholder">
                        <i class="fas fa-cloud-upload-alt text-2xl text-blue-200 group-hover:text-blue-500 transition mb-2"></i>
                        <span class="text-xs font-bold text-gray-400">اضغط لإضافة صورة</span>
                    </div>
                </div>`;
        }

        function renderImageBox(id, base64) {
            const container = document.getElementById(id);
            container.innerHTML = `
                <div class="upload-box has-image relative">
                    <img src="${base64}" class="uploaded-img">
                    <div class="img-actions">
                        <button onclick="changeImage(event, '${id}')" class="action-btn bg-blue-500"><i class="fas fa-pen"></i></button>
                        <button onclick="removeImage(event, '${id}')" class="action-btn bg-red-500"><i class="fas fa-trash"></i></button>
                    </div>
                    <input type="file" id="file-${id}" class="hidden" accept="image/*" onchange="processFile(event, '${id}')">
                </div>`;
        }

        function processFile(event, id) {
            const file = event.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                imageStore[id] = e.target.result;
                renderImageBox(id, e.target.result);
            };
            reader.readAsDataURL(file);
        }

        function changeImage(e, id) { e.stopPropagation(); document.getElementById(`file-${id}`).click(); }
        function removeImage(e, id) { e.stopPropagation(); delete imageStore[id]; renderEmptyBox(id); }

        function updateProgress() {
            let completedSections = 0;
            if (document.getElementById('input-fullName').value.trim().length > 0) completedSections++;
            if (document.getElementById('sashType').value) completedSections++;
            if (document.getElementById('capType').value) completedSections++;
            if (document.getElementById('gownType').value) completedSections++;
            document.getElementById('progress-bar').style.width = `${(completedSections / 4) * 100}%`;
            document.getElementById('progress-text').innerText = completedSections === 4 ? "مكتمل" : `قيد التعبئة`;
        }

        // ==================================================================
        // SEND LOGIC (Updated to match screenshot layout)
        // ==================================================================
        async function processAndSend() {
            const fullName = document.querySelector('[name="fullName"]').value.trim();
            if (!fullName) { Swal.fire('خطأ', 'يرجى كتابة الاسم الرباعي أولاً', 'error'); return; }

            const result = await Swal.fire({
                title: 'تأكيد الإرسال',
                text: "سيتم اعتماد الطلب وتوليد الملف.",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#16a34a',
                cancelButtonColor: '#d33',
                confirmButtonText: 'نعم',
                cancelButtonText: 'إلغاء'
            });

            if (!result.isConfirmed) return;

            document.getElementById('loading-overlay').style.display = 'flex';

            const htmlContent = generateExactStaticHTML(fullName);
            const dateStr = new Date().toISOString().split('T')[0];
            const fileName = `${fullName}_${dateStr}.html`;
            
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ filename: fileName, html: htmlContent })
                });
                
                const data = await response.json();
                document.getElementById('loading-overlay').style.display = 'none';

                if (data.result === 'success') {
                    Swal.fire('تم الإرسال!', `تم حفظ الملف باسم: ${fileName}`, 'success').then(() => location.reload());
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                document.getElementById('loading-overlay').style.display = 'none';
                Swal.fire('خطأ', 'فشل الإرسال، تحقق من الإنترنت', 'error');
            }
        }

        function generateExactStaticHTML(fullName) {
            const date = new Date().toLocaleDateString('en-GB'); 
            
            const getVal = (name) => document.querySelector(`[name="${name}"]`)?.value || '-';
            const getImg = (id) => imageStore[id] ? `<img src="${imageStore[id]}" style="width:100%;height:100%;object-fit:contain;">` : '<div style="color:#cbd5e1;font-size:0.8rem;">لا توجد صورة</div>';

            const createSection = (title, iconClass, colorClass, content) => `
                <div style="background:white; border:1px solid #e2e8f0; border-radius:16px; padding:24px; margin-bottom:24px; position:relative; overflow:hidden;">
                     <div style="position:absolute; top:0; right:0; width:6px; height:100%;" class="${colorClass}"></div>
                     <h2 style="font-size:1.25rem; font-weight:bold; color:#1f2937; margin-bottom:16px; display:flex; align-items:center; gap:8px;">
                        <i class="${iconClass}" style="color:inherit;"></i> ${title}
                     </h2>
                     ${content}
                </div>
            `;

            const createSelectedBox = (label, value) => `
                <div style="text-align:center; margin-bottom:24px;">
                    <div style="font-size:0.875rem; font-weight:bold; color:#4b5563; margin-bottom:8px;">${label}</div>
                    <div style="display:inline-block; background:#f0f9ff; color:#0369a1; padding:12px 32px; border-radius:12px; border:2px solid #bae6fd; font-weight:bold; font-size:1.1rem;">
                        ${value}
                    </div>
                </div>
            `;

            const createImageGrid = (title, images) => {
                if (images.every(img => img.includes('لا توجد صورة'))) return ''; 
                const cols = images.length > 1 ? 'grid-template-columns: 1fr 1fr;' : 'grid-template-columns: 1fr; max-width:300px; margin:0 auto;';
                return `
                <div style="background:#f8fafc; border:1px solid #e2e8f0; border-radius:12px; padding:16px; margin-bottom:16px;">
                    ${title ? `<h3 style="font-size:0.9rem; font-weight:bold; color:#4b5563; text-align:center; margin-bottom:12px; border-bottom:1px solid #e2e8f0; padding-bottom:8px;">${title}</h3>` : ''}
                    <div style="display:grid; ${cols} gap:16px; justify-items:center;">
                        ${images.map(img => `
                            <div style="width:100%; aspect-ratio:1/1; background:white; border:1px solid #e2e8f0; border-radius:12px; overflow:hidden; display:flex; align-items:center; justify-content:center;">
                                ${img}
                            </div>
                        `).join('')}
                    </div>
                </div>`;
            };

            const createDetailsGrid = (items) => `
                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:12px; margin-top:16px; padding-top:16px; border-top:1px solid #f1f5f9;">
                    ${items.map(item => `
                        <div style="background:#f9fafb; padding:12px; border-radius:8px;">
                            <div style="font-size:0.8rem; color:#6b7280; font-weight:bold; margin-bottom:4px;">${item.label}</div>
                            <div style="font-size:0.95rem; color:#1f2937; font-weight:bold;">${item.val}</div>
                        </div>
                    `).join('')}
                </div>
            `;

            // *** New: Side-by-Side Notes Layout ***
            const createNotesLayout = (noteText, imageKey, colorCode) => {
                const imgVal = imageStore[imageKey];
                const hasNote = noteText && noteText !== '-' && noteText.trim().length > 0;
                const hasImg = !!imgVal;

                if (!hasNote && !hasImg) return '';

                return `
                    <div style="margin-top: 24px; padding-top: 16px; border-top: 1px dashed #cbd5e1;">
                        <div style="display: flex; flex-wrap: wrap; gap: 20px; align-items: flex-start;">
                            
                            <!-- Notes Text Section (Right) -->
                            <div style="flex: 1; min-width: 200px;">
                                <h4 style="font-size: 0.9rem; font-weight: bold; color: ${colorCode}; margin-bottom: 8px;">ملاحظات إضافية</h4>
                                <div style="background: #fff; border: 1px solid #e2e8f0; border-radius: 12px; padding: 12px; min-height: 120px; font-size: 0.9rem; color: #334155; white-space: pre-wrap; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">${noteText || 'لا توجد ملاحظات'}</div>
                            </div>

                            <!-- Note Image Section (Left) -->
                            ${hasImg ? `
                            <div style="width: 150px; flex-shrink: 0;">
                                 <h4 style="font-size: 0.8rem; font-weight: bold; color: ${colorCode}; margin-bottom: 8px; text-align: center;">صورة مع الملاحظة (اختياري)</h4>
                                 <div style="width: 100%; aspect-ratio: 1/1; border: 2px solid #e2e8f0; border-radius: 12px; overflow: hidden; background: white; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
                                    <img src="${imgVal}" style="width: 100%; height: 100%; object-fit: cover;">
                                 </div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            };

            // --- BUILD SECTIONS ---

            // 1. Info
            const infoContent = `
                <div style="margin-top:16px;">
                    <div style="font-size:0.875rem; font-weight:bold; color:#4b5563; margin-bottom:8px;">الاسم الرباعي</div>
                    <div style="background:#f3f4f6; padding:16px; border-radius:12px; font-weight:bold; color:#111827; font-size:1.1rem;">${fullName}</div>
                </div>
            `;

            // 2. Sash
            const sashType = getVal('sashType');
            let sashContent = '';
            if(sashType && !sashType.includes('لا اريد')) {
                sashContent += createSelectedBox('اختيار نوع الوشاح', sashType);
                
                if(sashType.includes('جانبي')) {
                    sashContent += createImageGrid('النقش من الامام (الوشاح الجانبي)', [getImg('upload-sash-side-1')]);
                } else {
                    sashContent += createImageGrid('النقش من الامام (الوشاح ذو الجانبين)', [
                        `<div style="text-align:center;"><div style="font-size:0.7rem;color:#9ca3af;margin-bottom:4px;">الجهة اليمنى</div>${getImg('upload-sash-right')}</div>`, 
                        `<div style="text-align:center;"><div style="font-size:0.7rem;color:#9ca3af;margin-bottom:4px;">الجهة اليسرى</div>${getImg('upload-sash-left')}</div>`
                    ]);
                }
                if(sashType.includes('ملكي')) {
                    sashContent += createImageGrid('النقش من الخلف (خاص بالوشاح الملكي)', [getImg('upload-sash-back-1'), getImg('upload-sash-back-2')]);
                }

                // Basic Details
                sashContent += createDetailsGrid([
                    {label: 'لون الوشاح', val: getVal('sashColor')},
                    {label: 'لون الكركوشة', val: getVal('sashTasselColor')},
                    {label: 'لون النقش', val: getVal('sashEmbroideryColor')},
                ]);

                // Side-by-Side Notes
                sashContent += createNotesLayout(getVal('sashNotes'), 'upload-sash-notes', '#9333ea');

            } else {
                sashContent = '<div style="text-align:center; color:#ef4444; font-weight:bold; padding:20px;">لا اريد وشاح</div>';
            }

            // 3. Cap
            const capType = getVal('capType');
            let capContent = '';
            if(capType && !capType.includes('لا اريد')) {
                capContent += createSelectedBox('اختيار نوع القبعة', capType);
                
                const capLoc = getVal('capEmbroideryLoc');
                if(capLoc && !capLoc.includes('لا اريد')) {
                    capContent += createSelectedBox('مكان النقش على القبعة', capLoc);
                    const capImages = [];
                    if(capLoc.includes('فوق') || capLoc.includes('دبل')) capImages.push(`<div style="text-align:center;"><div style="font-size:0.7rem;color:#9ca3af;margin-bottom:4px;">النقش فوق القبعة</div>${getImg('upload-cap-top')}</div>`);
                    if(capLoc.includes('طوق') || capLoc.includes('دبل')) capImages.push(`<div style="text-align:center;"><div style="font-size:0.7rem;color:#9ca3af;margin-bottom:4px;">النقش على الطوق</div>${getImg('upload-cap-rim')}</div>`);
                    if(capImages.length > 0) capContent += createImageGrid('صور النقش', capImages);
                }

                capContent += createDetailsGrid([
                    {label: 'لون القبعة', val: getVal('capColor')},
                    {label: 'لون النقش', val: getVal('capEmbroideryColor')},
                    {label: 'لون الكركوشة', val: getVal('capTasselColor')},
                ]);

                // Side-by-Side Notes
                capContent += createNotesLayout(getVal('capNotes'), 'upload-cap-notes', '#4f46e5');

            } else {
                capContent = '<div style="text-align:center; color:#ef4444; font-weight:bold; padding:20px;">لا اريد قبعة</div>';
            }

            // 4. Gown
            const gownType = getVal('gownType');
            let gownContent = '';
            if(gownType && !gownType.includes('لا اريد')) {
                gownContent += createSelectedBox('نوع الروب', gownType);
                
                gownContent += createDetailsGrid([
                    {label: 'لون الروب', val: getVal('gownColor')},
                ]);

                // Side-by-Side Notes
                gownContent += createNotesLayout(getVal('gownNotes'), 'upload-gown-notes', '#059669');

            } else {
                gownContent = '<div style="text-align:center; color:#ef4444; font-weight:bold; padding:20px;">لا اريد روب</div>';
            }

            // --- FINAL HTML ---
            return `
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>${fullName}</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Tajawal', sans-serif; background-color: #fff; padding: 40px; margin:0; }
        @media print { body { padding: 0; } }
        .bg-blue-500 { background-color: #3b82f6; }
        .bg-purple-500 { background-color: #a855f7; }
        .bg-indigo-500 { background-color: #6366f1; }
        .bg-emerald-500 { background-color: #10b981; }
    </style>
</head>
<body>
    <div style="max-width:800px; margin:0 auto;">
        <div style="text-align:center; margin-bottom:40px;">
            <h1 style="font-size:2rem; font-weight:800; color:#1f2937; margin:0;">نموذج طلب تخرج</h1>
            <p style="font-size:1.5rem; font-weight:bold; color:#2563eb; margin:8px 0;">${fullName}</p>
            <p style="color:#9ca3af; font-size:0.9rem;">${date}</p>
        </div>

        ${createSection('قسم المعلومات', 'fas fa-user-graduate', 'bg-blue-500', infoContent)}
        ${createSection('أولاً: الوشاح', 'fas fa-ribbon', 'bg-purple-500', sashContent)}
        ${createSection('ثانياً: القبعة', 'fas fa-graduation-cap', 'bg-indigo-500', capContent)}
        ${createSection('ثالثاً: الروب', 'fas fa-tshirt', 'bg-emerald-500', gownContent)}

        <div style="text-align:center; margin-top:40px; border-top:1px solid #e5e7eb; padding-top:20px; color:#9ca3af; font-size:0.8rem;">
            تم إنشاء هذا المستند إلكترونياً - نسخة أرشيفية
        </div>
    </div>
</body>
</html>`;
        }
    </script>
</body>
</html>