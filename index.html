<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1280, user-scalable=yes" id="viewport-meta">
    <title>استمارة التخرج - النسخة المتكاملة</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@500;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <style>
        /* --- الأساسيات --- */
        body { font-family: 'Tajawal', sans-serif; background-color: #f1f5f9; width: 1280px; min-width: 1280px; margin: 0 auto; min-height: 100vh; overflow-x: hidden; font-size: 20px; }
        
        /* --- SweetAlert2 تخصيص --- */
        .swal2-container { z-index: 10000000 !important; }
        .swal2-popup { font-size: 2.2rem !important; width: 950px !important; padding: 3rem !important; border-radius: 3rem !important; box-shadow: 0 25px 50px rgba(0,0,0,0.5) !important; }
        .swal2-title { font-size: 4rem !important; font-weight: 900 !important; margin-bottom: 1.5rem !important; }
        .swal2-html-container { font-size: 2.8rem !important; line-height: 1.6 !important; margin: 2rem 0 !important; }
        .swal2-icon { width: 8em !important; height: 8em !important; margin: 2.5rem auto !important; border-width: .4em !important; }
        .swal2-actions { gap: 2rem !important; margin-top: 2rem !important; }
        .swal2-confirm, .swal2-deny, .swal2-cancel { font-size: 2.5rem !important; padding: 1.5rem 4rem !important; border-radius: 2rem !important; font-weight: 800 !important; display: flex !important; align-items: center; justify-content: center; }
        .swal2-input, .swal2-textarea { height: 5rem !important; font-size: 2.5rem !important; margin: 2rem auto !important; }

        /* --- الأزرار والعناصر المساعدة --- */
        .help-btn { border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 1.5rem; font-weight: 800; padding: 8px 20px; border-radius: 1rem; color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.15); transition: all 0.2s; line-height: 1; }
        .help-btn:hover { transform: translateY(-2px) scale(1.02); }
        .btn-purple { background: linear-gradient(135deg, #7e22ce, #6b21a8); }
        .btn-indigo { background: linear-gradient(135deg, #4f46e5, #4338ca); }
        .btn-emerald { background: linear-gradient(135deg, #059669, #047857); }

        /* --- نوافذ التعليمات --- */
        #custom-instruction-modal { display: none; position: fixed; inset: 0; z-index: 9999999; justify-content: center; align-items: center; background: rgba(0,0,0,0.95); backdrop-filter: blur(10px); }
        .instruction-sheet { background: #fff; width: 98%; max-width: 1260px; height: 98vh; border-radius: 3rem; display: flex; flex-direction: column; box-shadow: 0 40px 80px rgba(0,0,0,0.8); border: 6px solid #e2e8f0; overflow: hidden; animation: slideUp 0.25s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { transform: translateY(100px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .instruction-header { padding: 2.5rem; border-bottom: 5px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; }
        .instruction-title { font-size: 4rem; font-weight: 900; color: #1e293b; }
        .btn-close-modal { background: #fee2e2; color: #ef4444; width: 90px; height: 90px; border-radius: 50%; font-size: 3.5rem; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .btn-close-modal:hover { background: #ef4444; color: white; }
        .instruction-body { flex: 1; overflow-y: auto; padding: 3rem; background: #f8fafc; }
        .instruction-group-item { background: white; border-radius: 2.5rem; padding: 2.5rem; margin-bottom: 4rem; border: 4px solid #e2e8f0; }
        .group-item-title { font-size: 3.2rem; font-weight: 900; color: #1e3a8a; margin-bottom: 1.5rem; border-right: 12px solid #3b82f6; padding-right: 20px; }
        .group-item-desc { font-size: 2.4rem; line-height: 1.6; color: #475569; margin-bottom: 2.5rem; padding-right: 35px; font-weight: 700; }
        .item-gallery-container { width: 100%; overflow-x: auto; white-space: nowrap; padding-bottom: 20px; display: flex; gap: 30px; }
        .gallery-img-wrapper { width: 950px; min-width: 950px; aspect-ratio: 1; border-radius: 2rem; overflow: hidden; border: 5px solid #cbd5e1; background: #fff; flex-shrink: 0; }
        .gallery-img-wrapper img { width: 100%; height: 100%; object-fit: contain; cursor: zoom-in; transition: transform 0.3s; }
        .gallery-img-wrapper img:hover { transform: scale(1.02); }
        .sub-item-container { margin-top: 2rem; padding-top: 2rem; border-top: 4px dashed #e2e8f0; }
        .sub-item-title { font-size: 2.6rem; font-weight: 800; color: #059669; margin-bottom: 1rem; display: flex; align-items: center; gap: 15px; }

        /* --- البطاقات وحقول الرفع --- */
        .option-card { cursor: pointer; border: 5px solid #cbd5e1; border-radius: 1.2rem; padding: 2rem 1rem; font-size: 1.7rem; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; background: white; min-height: 140px; font-weight: 900; color: #1e293b; }
        .option-card:hover { border-color: #64748b; transform: translateY(-5px); box-shadow: 0 12px 20px -5px rgba(0,0,0,0.15); }
        .option-card.active-purple { background: #f3e8ff; border-color: #7e22ce; color: #581c87; box-shadow: 0 0 0 6px #d8b4fe; transform: scale(1.02); z-index: 10; }
        .option-card.active-indigo { background: #e0e7ff; border-color: #4f46e5; color: #312e81; box-shadow: 0 0 0 5px #a5b4fc; transform: scale(1.02); z-index: 10; }
        .option-card.active-emerald { background: #d1fae5; border-color: #059669; color: #064e3b; box-shadow: 0 0 0 5px #6ee7b7; transform: scale(1.02); z-index: 10; }
        .option-card.active-gray { background: #f3f4f6; border-color: #4b5563; color: #111827; box-shadow: 0 0 0 5px #9ca3af; transform: scale(1.02); z-index: 10; }
        .checkbox-wrapper-active { background-color: #d1fae5 !important; border-color: #059669 !important; color: #064e3b !important; box-shadow: 0 0 0 4px #6ee7b7 !important; }
        .upload-container-wrapper { width: 100%; max-width: 100%; }
        .upload-box { width: 100%; aspect-ratio: 1; border: 5px dashed #94a3b8; border-radius: 1.5rem; position: relative; background: #f8fafc; overflow: hidden; display: flex; align-items: center; justify-content: center; transition: 0.3s; }
        .upload-box:hover { border-color: #3b82f6; background: #eff6ff; }
        .upload-box.has-image { border-style: solid; border-color: #cbd5e1; background: #fff; }
        .upload-placeholder { text-align: center; color: #64748b; pointer-events: none; }
        .upload-placeholder i { font-size: 5rem !important; margin-bottom: 1.5rem; } .upload-placeholder span { font-size: 1.8rem !important; font-weight: 900; }
        .uploaded-img { width: 100%; height: 100%; object-fit: contain; }
        .img-actions { position: absolute; top: 15px; right: 15px; display: flex; gap: 15px; z-index: 50; }
        .action-btn { width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; color: white !important; cursor: pointer; border: 3px solid white; box-shadow: 0 5px 10px rgba(0,0,0,0.4); }
        .btn-edit { background: #3b82f6 !important; } .btn-delete { background: #ef4444 !important; }
        .custom-input { transition: 0.2s; padding: 1.2rem !important; border-width: 4px !important; }
        .custom-input:focus { transform: translateY(-3px); border-color: #3b82f6; }
        .hidden { display: none !important; }
        #loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.98); z-index: 99999; display: none; flex-direction: column; align-items: center; justify-content: center; min-width: 1280px; }
        .loader { border: 12px solid #f3f3f3; border-top: 12px solid #3b82f6; border-radius: 50%; width: 120px; height: 120px; animation: spin 1s linear infinite; margin-bottom: 40px; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        /* --- محرر الصور والعرض --- */
        #image-editor-modal { position: fixed; inset: 0; background: #0f172a; z-index: 200000; display: none; flex-direction: column; min-width: 1280px; }
        .editor-header { display: flex; justify-content: space-between; padding: 30px 50px; height: 140px; background: #1e293b; z-index: 10; }
        .top-action-btn { display: flex; align-items: center; gap: 15px; padding: 15px 40px; border-radius: 3rem; font-weight: 900; font-size: 2rem; cursor: pointer; border: none; }
        .btn-cancel-edit { color: #f1f5f9; background: #334155; } .btn-save-edit { background: #3b82f6; color: white; }
        .history-btn { background: rgba(255,255,255,0.1); color: white; width: 70px; height: 70px; border-radius: 50%; font-size: 1.8rem; border: 2px solid rgba(255,255,255,0.2); }
        .history-btn:disabled { opacity: 0.3; }
        .editor-workspace { flex: 1; position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center; background: #000; padding: 40px; }
        .cropper-view-box { outline: 6px solid #22c55e !important; } .cropper-point { width: 50px !important; height: 50px !important; background: #22c55e !important; border: 5px solid white !important; margin: -25px !important; opacity: 1 !important; }
        .floating-toolbar { position: absolute; bottom: 50px; left: 50%; transform: translateX(-50%); background: #1e293b; border: 3px solid #334155; padding: 20px 60px; border-radius: 5rem; display: flex; gap: 80px; width: 80%; justify-content: center; z-index: 20; }
        .tool-btn { display: flex; flex-direction: column; align-items: center; gap: 15px; color: #94a3b8; background: transparent; border: none; cursor: pointer; }
        .tool-btn i { font-size: 4rem; } .tool-btn span { font-size: 1.8rem; font-weight: 800; }
        .rotation-controls { position: absolute; bottom: 240px; left: 50%; transform: translateX(-50%); width: 80%; display: flex; align-items: center; justify-content: space-between; gap: 20px; z-index: 40; background: rgba(30,41,59,0.9); padding: 15px 30px; border-radius: 4rem; border: 2px solid rgba(255,255,255,0.1); }
        .rotation-slider { -webkit-appearance: none; flex-grow: 1; height: 8px; background: rgba(255,255,255,0.2); border-radius: 5px; margin: 0 15px; }
        .rotation-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 30px; height: 30px; border-radius: 50%; background: #3b82f6; border: 3px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.5); }
        #btn-floating-save { position: absolute; bottom: 360px; left: 50%; transform: translateX(-50%) scale(0.5); background: #22c55e; color: white; padding: 15px 60px; border-radius: 4rem; font-size: 2.2rem; font-weight: 900; z-index: 50; border: 4px solid white; opacity: 0; pointer-events: none; transition: 0.2s; }
        #btn-floating-save.visible { opacity: 1; transform: translateX(-50%) scale(1); pointer-events: auto; }
        @media print { .no-print { display: none !important; } }
        /* Lightbox */
        #image-viewer-modal { display: none; position: fixed; z-index: 20000000; inset: 0; background: rgba(0,0,0,0.95); flex-direction: column; align-items: center; justify-content: center; touch-action: none; }
        #viewer-image { max-width: 100%; max-height: 100vh; object-fit: contain; cursor: grab; transition: transform 0.1s linear; }
        .viewer-close { position: absolute; top: 40px; right: 40px; color: #f1f1f1; font-size: 4rem; cursor: pointer; z-index: 20000001; background: rgba(255,255,255,0.15); width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .viewer-hint { position: absolute; bottom: 40px; color: rgba(255,255,255,0.6); font-size: 1.5rem; font-weight: bold; pointer-events: none; }
    </style>
</head>
<body class="min-h-screen pb-40">
    <div id="loading-overlay"><div class="loader"></div><h3 id="loading-text" class="text-3xl font-black text-gray-800">جاري المعالجة...</h3></div>

    <!-- Instruction Modal -->
    <div id="custom-instruction-modal">
        <div class="instruction-sheet">
            <div class="instruction-header">
                <button class="btn-close-modal" onclick="window.closeInstructionPopup()"><i class="fas fa-times"></i></button>
                <h3 id="modal-title" class="instruction-title">التعليمات</h3>
            </div>
            <div class="instruction-body" id="instruction-content-area"></div>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-white shadow-lg sticky top-0 z-40 no-print border-b-8 border-gray-200 mb-10 w-full">
        <div class="w-full px-10 py-6 flex flex-row justify-between items-center gap-8">
            <h1 class="text-4xl font-black text-gray-900">استمارة زي التخرج الذكية</h1>
            <div class="w-1/3 flex flex-col items-center">
                <div class="w-full bg-gray-200 rounded-full h-8 overflow-hidden shadow-inner border-2 border-gray-300">
                    <div id="progress-bar" class="bg-gradient-to-l from-blue-600 to-blue-800 h-8 rounded-full transition-all duration-700 ease-out" style="width: 0%"></div>
                </div>
                <span id="progress-text" class="text-2xl font-black text-blue-800 mt-3">جاري البدء...</span>
            </div>
        </div>
    </header>

    <main id="main-form-container" class="w-full mt-10 px-10 space-y-10">
        <form id="gradForm" onsubmit="return false;">
            <!-- Info Section -->
            <section class="bg-white p-10 rounded-[2.5rem] shadow-lg border-8 border-gray-100 relative overflow-hidden">
                <div class="absolute top-0 right-0 w-4 h-full bg-blue-600"></div>
                <h2 class="text-5xl font-black mb-10 text-gray-900 flex items-center gap-6"><i class="fas fa-user-graduate text-blue-600 bg-blue-100 p-5 rounded-3xl"></i> قسم المعلومات</h2>
                <div class="w-full">
                    <label class="block text-gray-800 font-black mb-4 text-4xl">الاسم الرباعي (إجباري)</label>
                    <input type="text" name="fullName" id="input-fullName" class="custom-input w-full p-8 border-4 border-gray-300 rounded-3xl outline-none bg-gray-50 text-4xl font-black text-gray-900" placeholder="اكتب اسمك الرباعي كاملاً..." required oninput="window.handleNameInput()" onblur="window.cleanNameInput(this)">
                    <p id="name-warning-msg" class="text-2xl text-red-600 mt-4 mr-3 font-black hidden"><i class="fas fa-exclamation-circle ml-2"></i><span id="name-warning-text"></span></p>
                </div>
            </section>

            <!-- Sash Section -->
            <section class="bg-white p-10 rounded-[2.5rem] shadow-lg border-8 border-gray-100 relative overflow-hidden">
                <div class="absolute top-0 right-0 w-4 h-full bg-purple-600"></div>
                <h2 class="text-5xl font-black mb-10 text-gray-900 flex items-center gap-6"><i class="fas fa-ribbon text-purple-600 bg-purple-100 p-5 rounded-3xl"></i> أولاً: الوشاح</h2>
                <div class="subsection-container border-4 border-purple-200 rounded-[2rem] p-10 mb-10">
                    <div class="border-b-4 border-purple-100 pb-2 mb-6 flex justify-between items-end">
                        <h3 class="text-3xl font-black text-purple-900 flex items-center gap-4"><span class="bg-purple-200 text-purple-800 rounded-full w-12 h-12 flex items-center justify-center text-2xl font-black">1</span> نوع الوشاح</h3>
                        <button type="button" onclick="window.openPreloadedInstruction('sash-type-group', 'أنواع الوشاح')" class="help-btn btn-purple"><i class="fas fa-question-circle"></i> مساعدة</button>
                    </div>
                    <input type="hidden" id="sashType" name="sashType">
                    <div class="grid grid-cols-4 gap-6">
                        <div class="option-card hover:bg-purple-50 sash-base-card" onclick="window.selectSashBase('عادي', this)">عادي</div>
                        <div class="option-card hover:bg-purple-50 sash-base-card" onclick="window.selectSashBase('مثلث', this)">مثلث</div>
                        <div class="option-card hover:bg-purple-50 sash-base-card" onclick="window.selectSashBase('ملكي فرعوني', this)">ملكي فرعوني</div>
                        <div class="option-card hover:bg-purple-50 sash-base-card" onclick="window.selectSashBase('ملكي مثلث', this)">ملكي مثلث</div>
                        <div class="option-card hover:bg-purple-50 sash-base-card" onclick="window.selectSashBase('جانبي', this)">جانبي</div>
                        <div class="option-card hover:bg-purple-50" id="card-american-toggle" onclick="window.toggleAmericanCard(this)">+ امريكي</div>
                        <div class="option-card hover:bg-red-50 col-span-2 sash-base-card" onclick="window.selectNoSash(this)"><span class="text-red-600 font-black">لا اريد وشاح</span></div>
                    </div>
                </div>

                <div id="sashContentWrapper" class="hidden space-y-8">
                    <div id="sashEndsContainer" class="subsection-container border-4 border-purple-200 rounded-[2rem] p-10">
                        <div class="border-b-4 border-purple-100 pb-2 mb-6 flex justify-between items-end">
                            <h3 class="text-3xl font-black text-purple-900">نوع نهايتي الوشاح</h3>
                            <button type="button" onclick="window.openPreloadedInstruction('sash-ends-group', 'نهايات الوشاح')" class="help-btn btn-purple"><i class="fas fa-question-circle"></i> مساعدة</button>
                        </div>
                        <input type="hidden" id="sashEndsType" name="sashEndsType">
                        <div class="flex flex-row justify-center gap-8">
                            <div class="option-card w-1/3 py-4 text-3xl font-black hover:bg-purple-50" onclick="window.selectOption('sashEndsType', 'نهاية مثلثة', this, 'purple')">نهاية مثلثة</div>
                            <div class="option-card w-1/3 py-4 text-3xl font-black hover:bg-purple-50" onclick="window.selectOption('sashEndsType', 'نهاية مائلة', this, 'purple')">نهاية مائلة</div>
                        </div>
                    </div>

                    <div class="subsection-container border-4 border-purple-200 rounded-[2rem] p-10 bg-purple-50/50">
                        <div class="border-b-4 border-purple-100 pb-2 mb-6 flex justify-between items-end">
                            <h3 class="text-3xl font-black text-purple-900 flex items-center gap-4"><span class="bg-purple-200 text-purple-800 rounded-full w-12 h-12 flex items-center justify-center text-2xl font-black">2</span> النقش على الوشاح</h3>
                            <button type="button" onclick="window.openPreloadedInstruction('sash-embroidery-group', 'النقش على الوشاح')" class="help-btn btn-purple"><i class="fas fa-question-circle"></i> مساعدة</button>
                        </div>
                        <div class="mb-8">
                            <h4 class="inner-subtitle text-purple-900 border-r-8 border-purple-600 pr-4 text-2xl font-black mb-6">النقش من الامام</h4>
                            <div id="sashSectionTwoSides" class="hidden grid grid-cols-2 gap-10 justify-items-center">
                                <div class="upload-container-wrapper"><label class="block text-2xl font-black text-gray-700 mb-4 text-center">الجهة اليمنى</label><div id="upload-sash-right"></div><textarea name="sashRightText" class="mt-5 w-full p-5 border-4 border-gray-300 rounded-2xl text-2xl font-bold outline-none resize-none" rows="3" placeholder="وصف النقش..."></textarea></div>
                                <div class="upload-container-wrapper"><label class="block text-2xl font-black text-gray-700 mb-4 text-center">الجهة اليسرى</label><div id="upload-sash-left"></div><textarea name="sashLeftText" class="mt-5 w-full p-5 border-4 border-gray-300 rounded-2xl text-2xl font-bold outline-none resize-none" rows="3" placeholder="وصف النقش..."></textarea></div>
                            </div>
                            <div id="sashSectionOneSide" class="hidden flex justify-center">
                                <div class="upload-container-wrapper w-3/5"><label class="block text-2xl font-black text-gray-700 mb-4 text-center">صورة النقش</label><div id="upload-sash-side-1"></div><textarea name="sashSideText" class="mt-5 w-full p-5 border-4 border-gray-300 rounded-2xl text-2xl font-bold outline-none resize-none" rows="3" placeholder="وصف النقش..."></textarea></div>
                            </div>
                        </div>
                        <div id="sashSectionBack" class="hidden pt-8 border-t-8 border-purple-200">
                            <h4 class="inner-subtitle text-purple-900 border-r-8 border-purple-600 pr-4 text-2xl font-black mb-6">النقش من الخلف (خاص بالوشاح الملكي)</h4>
                            <div class="grid grid-cols-2 gap-10 justify-items-center mb-6"><div class="upload-container-wrapper"><div id="upload-sash-back-1"></div></div><div class="upload-container-wrapper"><div id="upload-sash-back-2"></div></div></div>
                            <textarea name="sashBackText" class="w-full p-5 border-4 border-gray-300 rounded-2xl text-2xl font-bold outline-none resize-none" rows="3" placeholder="وصف النقش الخلفي..."></textarea>
                        </div>
                    </div>

                    <div class="subsection-container border-4 border-purple-200 rounded-[2rem] p-10">
                        <div class="border-b-4 border-purple-100 pb-2 mb-6 flex justify-between items-end">
                            <h3 class="text-3xl font-black text-purple-900 flex items-center gap-4"><span class="bg-purple-200 text-purple-800 rounded-full w-12 h-12 flex items-center justify-center text-2xl font-black">3</span> تنسيق الالوان</h3>
                            <button type="button" onclick="window.openPreloadedInstruction('sash-colors-group', 'ألوان الوشاح')" class="help-btn btn-purple"><i class="fas fa-question-circle"></i> مساعدة</button>
                        </div>
                        <div class="grid grid-cols-3 gap-8">
                            <div><label class="block text-gray-800 text-3xl font-black mb-4">لون الوشاح</label><input type="text" name="sashColor" class="custom-input w-full p-5 border-4 border-gray-300 rounded-2xl text-3xl font-black bg-gray-50"></div>
                            <div><label class="block text-gray-800 text-3xl font-black mb-4">لون الكركوشة</label><input type="text" name="sashTasselColor" class="custom-input w-full p-5 border-4 border-gray-300 rounded-2xl text-3xl font-black bg-gray-50"></div>
                            <div><label class="block text-gray-800 text-3xl font-black mb-4">لون النقش</label><input type="text" name="sashEmbroideryColor" class="custom-input w-full p-5 border-4 border-gray-300 rounded-2xl text-3xl font-black bg-gray-50"></div>
                        </div>
                    </div>

                    <div class="subsection-container border-4 border-purple-200 rounded-[2rem] p-10">
                        <div class="border-b-4 border-purple-100 pb-2 mb-6 flex justify-between items-end">
                            <h3 class="text-3xl font-black text-purple-900 flex items-center gap-4"><span class="bg-purple-200 text-purple-800 rounded-full w-12 h-12 flex items-center justify-center text-2xl font-black">4</span> ملاحظات إضافية</h3>
                            <button type="button" onclick="window.openPreloadedInstruction('sash-notes-group', 'ملاحظات الوشاح')" class="help-btn btn-purple"><i class="fas fa-question-circle"></i> مساعدة</button>
                        </div>
                        <div id="sashSectionAmericanNotes" class="hidden mb-8 border-b-4 border-purple-100 pb-8">
                            <h4 class="inner-subtitle text-purple-900 border-r-8 border-purple-600 pr-4 text-2xl font-black mb-6">ملاحظات الوشاح الامريكي</h4>
                            <div class="grid grid-cols-2 gap-10 justify-items-center mb-6"><div class="upload-container-wrapper"><div id="upload-sash-american-1"></div></div><div class="upload-container-wrapper"><div id="upload-sash-american-2"></div></div></div>
                            <textarea name="sashAmericanText" class="w-full p-5 border-4 border-gray-300 rounded-2xl text-2xl font-bold outline-none resize-none" rows="3" placeholder="ملاحظات الأمريكي..."></textarea>
                        </div>
                        <div class="flex flex-row gap-8 items-stretch">
                            <div class="flex-1"><textarea name="sashNotes" class="custom-input w-full h-full min-h-[250px] p-5 border-4 border-gray-300 rounded-3xl text-2xl font-bold resize-none bg-gray-50" placeholder="تفاصيل عامة..."></textarea></div>
                            <div class="w-[450px] flex-shrink-0 flex flex-col"><label class="block text-purple-900 text-2xl font-black mb-4 text-center">صورة توضيحية</label><div class="upload-container-wrapper w-full"><div id="upload-sash-notes"></div></div></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Cap Section -->
            <section class="bg-white p-10 rounded-[2.5rem] shadow-lg border-8 border-gray-100 relative overflow-hidden">
                <div class="absolute top-0 right-0 w-4 h-full bg-indigo-600"></div>
                <h2 class="text-5xl font-black mb-10 text-gray-900 flex items-center gap-6"><i class="fas fa-graduation-cap text-indigo-600 bg-indigo-100 p-5 rounded-3xl"></i> ثانياً: القبعة</h2>
                <div class="subsection-container border-4 border-indigo-200 rounded-[2rem] p-10 mb-10">
                    <div class="border-b-4 border-indigo-100 pb-2 mb-6 flex justify-between items-end">
                        <h3 class="text-3xl font-black text-indigo-900 flex items-center gap-4"><span class="bg-indigo-200 text-indigo-800 rounded-full w-12 h-12 flex items-center justify-center text-2xl font-black">1</span> نوع القبعة</h3>
                        <button type="button" onclick="window.openPreloadedInstruction('cap-type-group', 'أنواع القبعة')" class="help-btn btn-indigo"><i class="fas fa-question-circle"></i> مساعدة</button>
                    </div>
                    <input type="hidden" id="capType" name="capType">
                    <div class="grid grid-cols-3 gap-6">
                        <div class="option-card hover:bg-indigo-50" onclick="window.selectOption('capType', 'قبعة عادية', this, 'indigo')">قبعة دائرية (عادية)</div>
                        <div class="option-card hover:bg-indigo-50" onclick="window.selectOption('capType', 'قبعة ملكية', this, 'indigo')">قبعة مثلث (ملكية)</div>
                        <div class="option-card hover:bg-red-50" onclick="window.selectOption('capType', 'لا اريد قبعة', this, 'gray')"><span class="text-red-600 font-black">لا اريد قبعة</span></div>
                    </div>
                </div>
                <div id="capContentWrapper" class="hidden space-y-8">
                    <div class="subsection-container border-4 border-indigo-200 rounded-[2rem] p-10 bg-indigo-50/50">
                        <div class="border-b-4 border-indigo-100 pb-2 mb-6 flex justify-between items-end">
                            <h3 class="text-3xl font-black text-indigo-900 flex items-center gap-4"><span class="bg-indigo-200 text-indigo-800 rounded-full w-12 h-12 flex items-center justify-center text-2xl font-black">2</span> النقش على القبعة</h3>
                            <button type="button" onclick="window.openPreloadedInstruction('cap-embroidery-group', 'النقش على القبعة')" class="help-btn btn-indigo"><i class="fas fa-question-circle"></i> مساعدة</button>
                        </div>
                        <div class="mb-8">
                            <input type="hidden" id="capEmbroideryLoc" name="capEmbroideryLoc">
                            <div class="grid grid-cols-4 gap-6">
                                <div class="option-card py-6 hover:bg-indigo-50" onclick="window.selectOption('capEmbroideryLoc', 'فوق القبعة', this, 'indigo')">فوق القبعة</div>
                                <div class="option-card py-6 hover:bg-indigo-50" onclick="window.selectOption('capEmbroideryLoc', 'طوق القبعة', this, 'indigo')">طوق القبعة</div>
                                <div class="option-card py-6 hover:bg-indigo-50" onclick="window.selectOption('capEmbroideryLoc', 'دبل نقش', this, 'indigo')">دبل نقش</div>
                                <div class="option-card py-6 hover:bg-red-50" onclick="window.selectOption('capEmbroideryLoc', 'لا اريد نقش', this, 'gray')">لا اريد نقش</div>
                            </div>
                        </div>
                        <div class="flex flex-row gap-8 justify-center">
                            <div id="capSectionTop" class="hidden w-1/2 p-8 rounded-3xl border-4 border-indigo-200 bg-white"><h3 class="font-black text-2xl text-indigo-900 mb-5 text-center">صورة النقش (فوق القبعة)</h3><div class="upload-container-wrapper"><div id="upload-cap-top"></div><textarea name="capTopText" class="mt-5 w-full p-5 border-4 border-gray-300 rounded-2xl text-2xl font-bold outline-none resize-none" rows="3" placeholder="وصف النقش..."></textarea></div></div>
                            <div id="capSectionRim" class="hidden w-1/2 p-8 rounded-3xl border-4 border-indigo-200 bg-white"><h3 class="font-black text-2xl text-indigo-900 mb-5 text-center">صورة النقش (طوق القبعة)</h3><div class="upload-container-wrapper"><div id="upload-cap-rim"></div><textarea name="capRimText" class="mt-5 w-full p-5 border-4 border-gray-300 rounded-2xl text-2xl font-bold outline-none resize-none" rows="3" placeholder="وصف النقش..."></textarea></div></div>
                        </div>
                    </div>
                    <div class="subsection-container border-4 border-indigo-200 rounded-[2rem] p-10">
                        <div class="border-b-4 border-indigo-100 pb-2 mb-6 flex justify-between items-end">
                            <h3 class="text-3xl font-black text-indigo-900 flex items-center gap-4"><span class="bg-indigo-200 text-indigo-800 rounded-full w-12 h-12 flex items-center justify-center text-2xl font-black">3</span> تنسيق الالوان</h3>
                            <button type="button" onclick="window.openPreloadedInstruction('cap-colors-group', 'ألوان القبعة')" class="help-btn btn-indigo"><i class="fas fa-question-circle"></i> مساعدة</button>
                        </div>
                        <div class="grid grid-cols-3 gap-8">
                            <div><label class="block text-gray-800 text-3xl font-black mb-4">لون القبعة</label><input type="text" name="capColor" class="custom-input w-full p-5 border-4 border-gray-300 rounded-2xl text-3xl font-black bg-gray-50"></div>
                            <div><label class="block text-gray-800 text-3xl font-black mb-4">لون النقش</label><input type="text" name="capEmbroideryColor" class="custom-input w-full p-5 border-4 border-gray-300 rounded-2xl text-3xl font-black bg-gray-50"></div>
                            <div><label class="block text-gray-800 text-3xl font-black mb-4">لون الكركوشة</label><input type="text" name="capTasselColor" class="custom-input w-full p-5 border-4 border-gray-300 rounded-2xl text-3xl font-black bg-gray-50"></div>
                        </div>
                    </div>
                    <div class="subsection-container border-4 border-indigo-200 rounded-[2rem] p-10">
                        <div class="border-b-4 border-indigo-100 pb-2 mb-6 flex justify-between items-end">
                            <h3 class="text-3xl font-black text-indigo-900 flex items-center gap-4"><span class="bg-indigo-200 text-indigo-800 rounded-full w-12 h-12 flex items-center justify-center text-2xl font-black">4</span> ملاحظات إضافية</h3>
                            <button type="button" onclick="window.openPreloadedInstruction('cap-notes-group', 'ملاحظات القبعة')" class="help-btn btn-indigo"><i class="fas fa-question-circle"></i> مساعدة</button>
                        </div>
                        <div class="flex flex-row gap-8 items-stretch">
                            <div class="flex-1"><textarea name="capNotes" class="custom-input w-full h-full min-h-[250px] p-5 border-4 border-gray-300 rounded-3xl text-2xl font-bold resize-none bg-gray-50" placeholder="تفاصيل إضافية..."></textarea></div>
                            <div class="w-[450px] flex-shrink-0 flex flex-col"><label class="block text-indigo-900 text-2xl font-black mb-4 text-center">صورة توضيحية</label><div class="upload-container-wrapper w-full"><div id="upload-cap-notes"></div></div></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Gown Section -->
            <section class="bg-white p-10 rounded-[2.5rem] shadow-lg border-8 border-gray-100 relative overflow-hidden">
                <div class="absolute top-0 right-0 w-4 h-full bg-emerald-600"></div>
                <h2 class="text-5xl font-black mb-10 text-gray-900 flex items-center gap-6"><i class="fas fa-tshirt text-emerald-600 bg-emerald-100 p-5 rounded-3xl"></i> ثالثاً: الروب</h2>
                <div class="subsection-container border-4 border-emerald-200 rounded-[2rem] p-10 mb-10">
                    <div class="border-b-4 border-emerald-100 pb-2 mb-6 flex justify-between items-end">
                        <h3 class="text-3xl font-black text-emerald-900 flex items-center gap-4"><span class="bg-emerald-200 text-emerald-800 rounded-full w-12 h-12 flex items-center justify-center text-2xl font-black">1</span> نوع الروب</h3>
                        <button type="button" onclick="window.openPreloadedInstruction('gown-type-group', 'أنواع الروب')" class="help-btn btn-emerald"><i class="fas fa-question-circle"></i> مساعدة</button>
                    </div>
                    <input type="hidden" id="gownType" name="gownType">
                    <div class="grid grid-cols-3 gap-6">
                        <div class="option-card hover:bg-emerald-50" onclick="window.selectOption('gownType', 'روب خليجي', this, 'emerald')">روب خليجي</div>
                        <div class="option-card hover:bg-emerald-50" onclick="window.selectOption('gownType', 'روب امريكي', this, 'emerald')">روب امريكي</div>
                        <div class="option-card hover:bg-red-50" onclick="window.selectOption('gownType', 'لا اريد روب', this, 'gray')"><span class="text-red-600 font-black">لا اريد روب</span></div>
                    </div>
                    <div id="americanGownOptions" class="hidden mt-8 pt-6 border-t-4 border-emerald-100">
                        <h4 class="text-2xl font-black text-emerald-800 mb-6 text-center">خيارات الروب الأمريكي</h4>
                        <div class="flex flex-row flex-wrap justify-center gap-6 px-4">
                            <label class="flex items-center gap-4 cursor-pointer p-5 rounded-2xl border-4 border-emerald-200 bg-emerald-50/30 hover:bg-emerald-100"><input type="checkbox" name="americanGownPleats[]" value="كسرات كتف" onchange="window.toggleCheckboxStyle(this)" class="w-10 h-10 accent-emerald-600"><span class="text-3xl font-black text-gray-800">كسرات كتف</span></label>
                            <label class="flex items-center gap-4 cursor-pointer p-5 rounded-2xl border-4 border-emerald-200 bg-emerald-50/30 hover:bg-emerald-100"><input type="checkbox" name="americanGownPleats[]" value="كسرات الصدر" onchange="window.toggleCheckboxStyle(this)" class="w-10 h-10 accent-emerald-600"><span class="text-3xl font-black text-gray-800">كسرات الصدر</span></label>
                            <label class="flex items-center gap-4 cursor-pointer p-5 rounded-2xl border-4 border-emerald-200 bg-emerald-50/30 hover:bg-emerald-100"><input type="checkbox" name="americanGownPleats[]" value="كسرات الظهر" onchange="window.toggleCheckboxStyle(this)" class="w-10 h-10 accent-emerald-600"><span class="text-3xl font-black text-gray-800">كسرات الظهر</span></label>
                        </div>
                    </div>
                </div>

                <div id="gownContentWrapper" class="hidden space-y-8">
                    <div class="subsection-container border-4 border-emerald-200 rounded-[2rem] p-10">
                        <div class="border-b-4 border-emerald-100 pb-2 mb-6 flex justify-between items-end">
                            <h3 class="text-3xl font-black text-emerald-900 flex items-center gap-4"><span class="bg-emerald-200 text-emerald-800 rounded-full w-12 h-12 flex items-center justify-center text-2xl font-black">2</span> إضافات الروب</h3>
                            <button type="button" onclick="window.openPreloadedInstruction('gown-additions-group', 'إضافات الروب')" class="help-btn btn-emerald"><i class="fas fa-question-circle"></i> مساعدة</button>
                        </div>
                        <div class="flex flex-col gap-6 px-10 items-center">
                            <label class="flex items-center gap-6 cursor-pointer p-6 rounded-3xl border-4 border-emerald-200 bg-emerald-50/30 hover:bg-emerald-100 w-full max-w-3xl"><input type="checkbox" name="gownAdditions[]" value="تطعيم الردان بلون الوشاح" onchange="window.toggleCheckboxStyle(this)" class="w-10 h-10 accent-emerald-600"><span class="text-3xl font-bold text-gray-800">تطعيم الردان بلون الوشاح</span></label>
                            <label class="flex items-center gap-6 cursor-pointer p-6 rounded-3xl border-4 border-emerald-200 bg-emerald-50/30 hover:bg-emerald-100 w-full max-w-3xl"><input type="checkbox" name="gownAdditions[]" value="تطريز الردان" onchange="window.toggleCheckboxStyle(this); window.handleGownEmbroideryChange(this)" class="w-10 h-10 accent-emerald-600"><span class="text-3xl font-bold text-gray-800">تطريز الردان</span></label>
                        </div>
                        <div id="gownEmbroideryUploadSection" class="hidden mt-8 pt-6 border-t-4 border-emerald-100 bg-emerald-50/30 rounded-2xl p-6 flex justify-center">
                            <div class="upload-container-wrapper w-3/5"><label class="block text-2xl font-black text-gray-700 mb-4 text-center">صورة النقش</label><div id="upload-gown-embroidery"></div><textarea name="gownEmbroideryText" class="mt-5 w-full p-5 border-4 border-gray-300 rounded-2xl text-2xl font-bold outline-none resize-none" rows="3" placeholder="وصف التطريز..."></textarea></div>
                        </div>
                    </div>
                    <div class="subsection-container border-4 border-emerald-200 rounded-[2rem] p-10">
                        <div class="border-b-4 border-emerald-100 pb-2 mb-6 flex justify-between items-end">
                            <h3 class="text-3xl font-black text-emerald-900 flex items-center gap-4"><span class="bg-emerald-200 text-emerald-800 rounded-full w-12 h-12 flex items-center justify-center text-2xl font-black">3</span> تنسيق الالوان</h3>
                            <button type="button" onclick="window.openPreloadedInstruction('gown-colors-group', 'ألوان الروب')" class="help-btn btn-emerald"><i class="fas fa-question-circle"></i> مساعدة</button>
                        </div>
                        <div class="grid grid-cols-2 gap-8">
                            <div><label class="block text-gray-800 text-3xl font-black mb-4">لون الروب</label><input type="text" name="gownColor" class="custom-input w-full p-5 border-4 border-gray-300 rounded-2xl text-3xl font-black bg-gray-50"></div>
                        </div>
                    </div>
                    <div class="subsection-container border-4 border-emerald-200 rounded-[2rem] p-10">
                        <div class="border-b-4 border-emerald-100 pb-2 mb-6 flex justify-between items-end">
                            <h3 class="text-3xl font-black text-emerald-900 flex items-center gap-4"><span class="bg-emerald-200 text-emerald-800 rounded-full w-12 h-12 flex items-center justify-center text-2xl font-black">4</span> ملاحظات إضافية</h3>
                            <button type="button" onclick="window.openPreloadedInstruction('gown-notes-group', 'ملاحظات الروب')" class="help-btn btn-emerald"><i class="fas fa-question-circle"></i> مساعدة</button>
                        </div>
                        <div class="flex flex-row gap-8 items-stretch">
                            <div class="flex-1"><textarea name="gownNotes" class="custom-input w-full h-full min-h-[250px] p-5 border-4 border-gray-300 rounded-3xl text-2xl font-bold resize-none bg-gray-50" placeholder="تفاصيل إضافية..."></textarea></div>
                            <div class="w-[450px] flex-shrink-0 flex flex-col"><label class="block text-emerald-900 text-2xl font-black mb-4 text-center">صورة توضيحية</label><div class="upload-container-wrapper w-full"><div id="upload-gown-notes"></div></div></div>
                        </div>
                    </div>
                </div>
            </section>

            <div class="w-full flex justify-center py-12 no-print mt-14 border-t-8 border-gray-200">
                <button onclick="window.initiateSendProcess()" class="w-2/3 p-10 bg-green-600 text-white rounded-full shadow-2xl hover:bg-green-700 transition transform hover:scale-105 flex items-center justify-center gap-6 font-black text-4xl ring-8 ring-green-200 group">
                    <span class="group-hover:animate-pulse"><i class="fas fa-paper-plane text-5xl ml-2"></i></span> إرسال واعتماد الطلب
                </button>
            </div>
        </form>
    </main>

    <!-- Editors & Modals -->
    <div id="image-editor-modal">
        <div class="editor-header">
            <button onclick="window.closeEditor()" class="top-action-btn btn-cancel-edit"><i class="fas fa-times"></i> إلغاء</button>
            <div class="header-controls">
                <button onclick="window.undoEdit()" class="history-btn" id="btn-undo" disabled><i class="fas fa-undo"></i></button>
                <button onclick="window.redoEdit()" class="history-btn" id="btn-redo" disabled><i class="fas fa-redo"></i></button>
            </div>
            <button onclick="window.saveEditorImage()" class="top-action-btn btn-save-edit"><i class="fas fa-check"></i> إدراج</button>
        </div>
        <div class="editor-workspace">
            <img id="editor-image-target" src="" alt="Editing" style="max-width: 100%; display: block;">
            <button id="btn-floating-save" onclick="window.saveIntermediateChanges()"><i class="fas fa-check-circle"></i> حفظ التغييرات</button>
            <div class="rotation-controls">
                <button onclick="window.rotate90(-90)" class="mini-rotate-btn text-white text-2xl"><i class="fas fa-undo"></i></button>
                <input type="range" min="-45" max="45" value="0" class="rotation-slider" oninput="window.handleRotation(this.value)">
                <button onclick="window.rotate90(90)" class="mini-rotate-btn text-white text-2xl"><i class="fas fa-redo"></i></button>
            </div>
        </div>
        <div class="floating-toolbar">
            <button onclick="window.applyFilter()" class="tool-btn group"><i class="fas fa-wand-magic-sparkles"></i><span>فلتر</span></button>
            <button onclick="window.resetView()" class="tool-btn active"><i class="fas fa-crop-alt"></i><span>إعادة ضبط</span></button>
        </div>
    </div>
    
    <div id="image-viewer-modal"><span class="viewer-close" onclick="window.closeImageViewer()">&times;</span><img id="viewer-image"><div class="viewer-hint">اسحب للتحريك • باعد اصبعيك للتكبير</div></div>

    <script>
        // --- تهيئة البيانات والمتغيرات ---
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxp_GUP-5YMOVMxQKjTVL65CYPKqLB3r6b3f_wAAGRXvJUiSsmUoVKF3AfTco95bdp6Jg/exec";
        const uploadIDs = ['upload-sash-right','upload-sash-left','upload-sash-back-1','upload-sash-back-2','upload-sash-side-1','upload-sash-notes','upload-cap-top','upload-cap-rim','upload-cap-notes','upload-gown-notes','upload-gown-embroidery','upload-sash-american-1','upload-sash-american-2'];
        
        // تم اختصار قاعدة البيانات لتوفير المساحة
        const imageDataBase = {
             'عادي':['1.1 .jpg','1.2 .jpg','1.3.jpg','1.4.jpg','1.5 .jpg'], 'مثلث':['2.1.jpg','2.2.jpg','2.3.jpg','2.4.jpg','2.5 .jpg'],
             'ملكي فرعوني':['4.1.jpg','4.2.jpg','4.3.jpg','4.4.jpg','4.5.jpg'], 'ملكي مثلث':['3.1.jpg','3.2.jpg','3.3.jpg','3.4.jpg','3.5.jpg','3.6.jpg'],
             'جانبي':['5.1.jpg','5.2.jpg','5.3.jpg','5.4.jpg','5.5.jpg'], 'امريكي':['6.1.jpg','6.2.jpg','6.3.jpg','6.4.jpg','6.5.jpg'],
             'نهاية مثلثة':['7.1.jpg'], 'نهاية مائلة':['7.2.jpg'], 'لون الوشاح':['1.3.1.jpg'], 'لون نقش الوشاح':['1.3.2.1.jpg','1.3.2.2.jpg'], 'لون الكركوشة':['1.3.3.1.jpg','1.3.3.2.jpg'],
             'قبعة عادية':['2.1.1.1.jpg','2.1.1.2.jpg'], 'قبعة ملكية':['2.1.2.1.jpg','2.1.2.2.jpg'], 'فوق القبعة':['2.2.1.jpg'], 'طوق القبعة':['2.2.2.jpg'], 'دبل نقش':['2.2.3.jpg'], 'لا اريد نقش':['2.2.4.jpg'],
             'لون القبعة':['2.3.1.1.jpg','2.3.1.2.jpg'], 'لون نقش القبعة':['2.3.2.1.jpg','2.3.2.2.jpg'], 'لون كركوشة القبعة':['2.3.3.1.jpg','2.3.3.2.jpg'],
             'روب خليجي':['3.1.1.1.jpg','3.1.1.2.jpg'], 'روب امريكي':['3.1.2.1.jpg','3.1.2.2.jpg','3.1.2.3.jpg','3.1.2.4.jpg'],
             'كسرات كتف':['3.1.2.5.jpg'], 'كسرات الصدر':['3.1.2.6.jpg'], 'كسرات الظهر':['3.1.2.7.jpg'], 'تطريز الردان':['3.2.1.1.jpg','3.2.1.2.jpg'], 'تطعيم الردان':['3.2.1.3.jpg'], 'لون الروب':['3.3.1.jpg','3.3.2.jpg']
        };

        const instructionGroups = {
            'sash-type-group': [
                {t:'الوشاح العادي',d:'التصميم التقليدي.',i:imageDataBase['عادي']}, {t:'الوشاح المثلث',d:'قصة مثلثة.',i:imageDataBase['مثلث']},
                {t:'الوشاح الفرعوني',d:'طراز فرعوني.',i:imageDataBase['ملكي فرعوني']}, {t:'الوشاح الملكي',d:'فخامة ومثلث.',i:imageDataBase['ملكي مثلث']},
                {t:'الوشاح الجانبي',d:'جانب واحد.',i:imageDataBase['جانبي']}, {t:'الوشاح الأمريكي',d:'النمط الأمريكي.',i:imageDataBase['امريكي']}
            ],
            'sash-ends-group': [{t:'نهاية مثلثة',d:'مثلث حاد.',i:imageDataBase['نهاية مثلثة']}, {t:'نهاية مائلة',d:'قصة مائلة.',i:imageDataBase['نهاية مائلة']}],
            'sash-embroidery-group': [{t:'النقش',d:'اختر النقش.',i:[]}],
            'sash-colors-group': [{t:'لون الوشاح',d:'اللون الأساسي.',i:imageDataBase['لون الوشاح']}, {t:'الكركوشة',d:'الخيوط المتدلية.',i:imageDataBase['لون الكركوشة']}, {t:'لون النقش',d:'خيوط التطريز.',i:imageDataBase['لون نقش الوشاح']}],
            'sash-notes-group': [{t:'ملاحظات',d:'تفاصيل إضافية.',i:[]}],
            'cap-type-group': [{t:'قبعة عادية',d:'دائرية.',i:imageDataBase['قبعة عادية']}, {t:'قبعة ملكية',d:'مثلثة.',i:imageDataBase['قبعة ملكية']}],
            'cap-embroidery-group': [{t:'فوق القبعة',d:'الجزء العلوي.',i:imageDataBase['فوق القبعة']}, {t:'طوق القبعة',d:'الطوق الدائري.',i:imageDataBase['طوق القبعة']}, {t:'دبل نقش',d:'أعلى وطوق.',i:imageDataBase['دبل نقش']}, {t:'بدون نقش',d:'سادة.',i:imageDataBase['لا اريد نقش']}],
            'cap-colors-group': [{t:'لون القبعة',d:'الأساسي.',i:imageDataBase['لون القبعة']}, {t:'لون النقش',d:'التطريز.',i:imageDataBase['لون نقش القبعة']}, {t:'الكركوشة',d:'المتدلي.',i:imageDataBase['لون كركوشة القبعة']}],
            'cap-notes-group': [{t:'ملاحظات',d:'تفاصيل.',i:[]}],
            'gown-type-group': [
                {t:'روب خليجي',d:'واسع ومريح.',i:imageDataBase['روب خليجي']}, 
                {t:'روب امريكي',d:'رسمي.',i:imageDataBase['روب امريكي'], sub:[{t:'كسرات صدر',d:'طولية.',i:imageDataBase['كسرات الصدر']},{t:'كسرات ظهر',d:'بالخلف.',i:imageDataBase['كسرات الظهر']},{t:'كسرات كتف',d:'بالكتف.',i:imageDataBase['كسرات كتف']}]}
            ],
            'gown-additions-group': [{t:'تطريز الردان',d:'نقش الأكمام.',i:imageDataBase['تطريز الردان']}, {t:'تطعيم الردان',d:'قماش ملون.',i:imageDataBase['تطعيم الردان']}],
            'gown-colors-group': [{t:'لون الروب',d:'الأساسي.',i:imageDataBase['لون الروب']}],
            'gown-notes-group': [{t:'ملاحظات',d:'تفاصيل.',i:[]}]
        };

        let imageStore={}, currentEditorCropper=null, currentEditingUploadId=null, editHistory=[], historyIndex=-1, filterIndex=0;
        const filters=['','grayscale(100%)','sepia(0.5)','contrast(150%) brightness(110%)'];
        let currentBaseRotation=0, currentFineRotation=0, baseSashType='', isAmericanSash=false;
        let currentViewerScale=1, startDist=0, startScale=1, isPinching=false, isDragging=false, startX=0, startY=0, translateX=0, translateY=0;

        // --- تهيئة الصفحة ---
        document.addEventListener('DOMContentLoaded', () => {
            initUploadBoxes(); updateProgress(); initAllInstructions();
            setTimeout(preloadImagesSmartly, 1000);
        });

        // --- دوال التعليمات ---
        function initAllInstructions() {
            const area = document.getElementById('instruction-content-area');
            Object.keys(instructionGroups).forEach(key => {
                const grp = document.createElement('div'); grp.id = `group-${key}`; grp.className='instruction-group-container'; grp.style.display='none';
                if(!instructionGroups[key].length) grp.innerHTML = `<p class="text-3xl text-gray-500 text-center mt-10">لا توجد تفاصيل.</p>`;
                else instructionGroups[key].forEach(item => {
                    const div = document.createElement('div'); div.className='instruction-group-item';
                    div.innerHTML = `<h4 class="group-item-title"><i class="fas fa-bookmark ml-4 text-blue-400"></i> ${item.t}</h4><p class="group-item-desc">${item.d}</p>`;
                    if(item.i && item.i.length) div.appendChild(createGallery(item.i));
                    if(item.sub) item.sub.forEach(s => {
                        const subD = document.createElement('div'); subD.className='sub-item-container';
                        subD.innerHTML = `<h5 class="sub-item-title"><i class="fas fa-caret-left text-emerald-500"></i> ${s.t}</h5><p class="sub-item-desc">${s.d}</p>`;
                        if(s.i) subD.appendChild(createGallery(s.i));
                        div.appendChild(subD);
                    });
                    grp.appendChild(div);
                });
                area.appendChild(grp);
            });
        }

        function createGallery(imgs) {
            const d = document.createElement('div'); d.className='item-gallery-container';
            imgs.forEach(src => d.innerHTML += `<div class="gallery-img-wrapper"><img src="${src}" loading="eager" onclick="window.openImageViewer(this.src)"></div>`);
            return d;
        }

        window.openPreloadedInstruction = (key, title) => {
            document.getElementById('modal-title').textContent = title;
            document.querySelectorAll('.instruction-group-container').forEach(e => e.style.display='none');
            const g = document.getElementById(`group-${key}`); if(g) g.style.display='block';
            document.getElementById('custom-instruction-modal').style.display='flex';
            document.querySelector('.instruction-body').scrollTop = 0;
        };
        window.closeInstructionPopup = () => document.getElementById('custom-instruction-modal').style.display='none';

        // --- عارض الصور (Lightbox) ---
        window.openImageViewer = (src) => {
            const m = document.getElementById('image-viewer-modal');
            document.getElementById('viewer-image').src = src; m.style.display='flex';
            currentViewerScale=1; translateX=0; translateY=0; updateTransform();
            document.querySelector('#viewport-meta').setAttribute('content','width=1280, user-scalable=no');
        };
        window.closeImageViewer = () => {
            document.getElementById('image-viewer-modal').style.display='none';
            document.querySelector('#viewport-meta').setAttribute('content','width=1280, user-scalable=yes');
        };

        const vImg = document.getElementById('viewer-image'), vModal = document.getElementById('image-viewer-modal');
        function updateTransform() { vImg.style.transform = `translate(${translateX}px, ${translateY}px) scale(${currentViewerScale})`; }
        function getDist(ts) { return Math.hypot(ts[0].pageX-ts[1].pageX, ts[0].pageY-ts[1].pageY); }

        vModal.addEventListener('touchstart', e => {
            if(e.touches.length===2) { e.preventDefault(); isPinching=true; startDist=getDist(e.touches); startScale=currentViewerScale; }
            else if(e.touches.length===1) {
                if(currentViewerScale>1) { isDragging=true; startX=e.touches[0].pageX-translateX; startY=e.touches[0].pageY-translateY; }
            }
        }, {passive:false});
        
        vModal.addEventListener('touchmove', e => {
            if(isPinching && e.touches.length===2) { e.preventDefault(); currentViewerScale = Math.max(1, Math.min(startScale*(getDist(e.touches)/startDist), 5)); updateTransform(); }
            else if(isDragging && e.touches.length===1) { e.preventDefault(); translateX=e.touches[0].pageX-startX; translateY=e.touches[0].pageY-startY; updateTransform(); }
        }, {passive:false});
        
        vModal.addEventListener('touchend', () => { isPinching=false; isDragging=false; if(currentViewerScale<1) { currentViewerScale=1; translateX=0; translateY=0; updateTransform(); } });
        vModal.addEventListener('click', e => { if(e.target===vModal && !isDragging && !isPinching) window.closeImageViewer(); });

        // --- منطق النموذج ---
        window.selectOption = (id, val, el, th) => {
            document.getElementById(id).value = val;
            el.parentElement.querySelectorAll('.option-card').forEach(c => c.classList.remove('active-purple','active-indigo','active-emerald','active-gray'));
            el.classList.add(`active-${th}`);
            if(id==='capType') toggleVis('capContentWrapper', val && !val.includes('لا اريد'));
            else if(id==='gownType') {
                toggleVis('gownContentWrapper', val && !val.includes('لا اريد'));
                toggleVis('americanGownOptions', val==='روب امريكي');
            } else if(id==='capEmbroideryLoc') {
                ['capSectionTop','capSectionRim'].forEach(i => document.getElementById(i).classList.add('hidden'));
                if(val.includes('فوق')||val.includes('دبل')) toggleVis('capSectionTop', true);
                if(val.includes('طوق')||val.includes('دبل')) toggleVis('capSectionRim', true);
            }
            updateProgress();
        };

        window.selectSashBase = (val, el) => { baseSashType=val; updateSashUI(el, false); };
        window.selectNoSash = (el) => { baseSashType='لا اريد وشاح'; isAmericanSash=false; updateSashUI(el, true); };
        window.toggleAmericanCard = (el) => { if(baseSashType!=='لا اريد وشاح') { isAmericanSash=!isAmericanSash; el.classList.toggle('active-purple', isAmericanSash); updateFinalSash(); } };
        
        function updateSashUI(el, isNo) {
            document.querySelectorAll('.sash-base-card').forEach(c => c.classList.remove('active-purple','active-gray'));
            el.classList.add(isNo?'active-gray':'active-purple');
            const am = document.getElementById('card-american-toggle');
            am.style.opacity = isNo ? '0.5' : '1'; am.style.pointerEvents = isNo ? 'none' : 'auto';
            if(isNo) am.classList.remove('active-purple');
            updateFinalSash();
        }

        function updateFinalSash() {
            const val = baseSashType==='لا اريد وشاح' || !baseSashType ? baseSashType : (isAmericanSash ? 'امريكي + '+baseSashType : baseSashType);
            document.getElementById('sashType').value = val;
            const w = document.getElementById('sashContentWrapper');
            if(!val || val.includes('لا اريد')) w.classList.add('hidden');
            else {
                w.classList.remove('hidden');
                toggleVis('sashSectionTwoSides', !val.includes('جانبي'));
                toggleVis('sashSectionOneSide', val.includes('جانبي'));
                toggleVis('sashSectionBack', val.includes('ملكي'));
                toggleVis('sashSectionAmericanNotes', val.includes('امريكي'));
                toggleVis('sashEndsContainer', !val.includes('جانبي'));
            }
            updateProgress();
        }

        window.toggleCheckboxStyle = (cb) => cb.parentElement.classList.toggle('checkbox-wrapper-active', cb.checked);
        window.handleGownEmbroideryChange = (cb) => toggleVis('gownEmbroideryUploadSection', cb.checked);
        function toggleVis(id, show) { document.getElementById(id).classList.toggle('hidden', !show); }

        window.handleNameInput = () => {
            const inp = document.getElementById('input-fullName'), warn = document.getElementById('name-warning-msg'), txt = document.getElementById('name-warning-text');
            const res = validateName(inp.value);
            if(!inp.value.trim()) warn.classList.add('hidden');
            else if(!res.valid) { warn.classList.remove('hidden'); txt.textContent=res.msg; inp.classList.add('border-red-400'); inp.classList.remove('border-green-500'); }
            else { warn.classList.add('hidden'); inp.classList.remove('border-red-400'); inp.classList.add('border-green-500'); }
            updateProgress();
        };
        window.cleanNameInput = (el) => { el.value = el.value.replace(/[^\u0621-\u064A\s]/g,'').replace(/\s+/g,' ').trim(); window.handleNameInput(); };
        function validateName(n) {
            n=n.trim(); if(!n) return {valid:false};
            if(/[^ \u0621-\u064A]/.test(n)) return {valid:false, msg:"حروف عربية فقط"};
            if(n.split(' ').filter(p=>p.length>1).length<4) return {valid:false, msg:"يجب كتابة الاسم الرباعي"};
            return {valid:true};
        }

        // --- Upload Logic ---
        function initUploadBoxes() { uploadIDs.forEach(id => { if(!document.getElementById(id).querySelector('.upload-box')) renderEmptyBox(id); }); }
        function renderEmptyBox(id) { document.getElementById(id).innerHTML = `<div class="upload-box group" onclick="document.getElementById('file-${id}').click()"><input type="file" id="file-${id}" class="hidden" accept="image/*" onchange="window.processFile(event, '${id}')"><div class="upload-placeholder"><i class="fas fa-cloud-upload-alt group-hover:text-blue-500 transition mb-2"></i><span class="block">ارفق صورة</span></div></div>`; }
        function renderImageBox(id, b64) { document.getElementById(id).innerHTML = `<div class="upload-box has-image relative"><img src="${b64}" class="uploaded-img"><div class="img-actions"><button onclick="window.reEditImage(event,'${id}')" class="action-btn btn-edit"><i class="fas fa-pen"></i></button><button onclick="window.removeImage(event,'${id}')" class="action-btn btn-delete"><i class="fas fa-trash"></i></button></div><input type="file" id="file-${id}" class="hidden" accept="image/*" onchange="window.processFile(event,'${id}')"></div>`; }
        window.processFile = (e, id) => { const f=e.target.files[0]; if(f) { const r=new FileReader(); r.onload=x=>openEditor(id, x.target.result); r.readAsDataURL(f); } e.target.value=''; };
        window.removeImage = (e, id) => { e.stopPropagation(); delete imageStore[id]; renderEmptyBox(id); };
        window.reEditImage = (e, id) => { e.stopPropagation(); if(imageStore[id]) openEditor(id, imageStore[id]); };

        // --- Editor Logic ---
        function openEditor(id, src) {
            currentEditingUploadId=id; editHistory=[src]; historyIndex=0; currentBaseRotation=0; currentFineRotation=0; filterIndex=0;
            const img = document.getElementById('editor-image-target'); img.src=src; img.style.filter='';
            document.getElementById('image-editor-modal').style.display='flex';
            document.querySelector('.rotation-slider').value=0; updateHistoryBtns(); lockZoom();
            if(currentEditorCropper) currentEditorCropper.destroy();
            setTimeout(() => {
                currentEditorCropper = new Cropper(img, {
                    viewMode:1, dragMode:'none', autoCropArea:0.8, background:false,
                    cropstart:()=>showSaveBtn(), cropmove:()=>showSaveBtn(), ready:()=>applyRot()
                });
            }, 50);
        }
        function showSaveBtn() { document.getElementById('btn-floating-save').classList.add('visible'); }
        function applyRot() { if(currentEditorCropper) currentEditorCropper.rotateTo(currentBaseRotation+parseFloat(currentFineRotation)); showSaveBtn(); }
        window.handleRotation = v => { currentFineRotation=v; applyRot(); };
        window.rotate90 = d => { currentBaseRotation+=d; applyRot(); };
        window.applyFilter = () => { filterIndex=(filterIndex+1)%filters.length; document.getElementById('editor-image-target').style.filter=filters[filterIndex]; showSaveBtn(); };
        window.saveIntermediateChanges = () => {
            if(!currentEditorCropper) return;
            let cvs = currentEditorCropper.getCroppedCanvas({fillColor:'#fff'});
            if(filterIndex>0) { const t=document.createElement('canvas'); t.width=cvs.width; t.height=cvs.height; const c=t.getContext('2d'); c.filter=filters[filterIndex]; c.drawImage(cvs,0,0); cvs=t; }
            const b64 = cvs.toDataURL('image/jpeg'); editHistory = editHistory.slice(0, historyIndex+1); editHistory.push(b64); historyIndex++;
            updateHistoryBtns(); reloadEditorState(b64);
        };
        window.undoEdit = () => { if(historyIndex>0) reloadEditorState(editHistory[--historyIndex]); };
        window.redoEdit = () => { if(historyIndex<editHistory.length-1) reloadEditorState(editHistory[++historyIndex]); };
        function reloadEditorState(src) {
            const img=document.getElementById('editor-image-target'); img.src=src; img.style.filter=''; filterIndex=0; currentBaseRotation=0; currentFineRotation=0;
            document.querySelector('.rotation-slider').value=0; if(currentEditorCropper) currentEditorCropper.destroy();
            setTimeout(() => { currentEditorCropper = new Cropper(img, { viewMode:1, dragMode:'none', autoCropArea:0.8, background:false, cropstart:()=>showSaveBtn(), cropmove:()=>showSaveBtn() }); document.getElementById('btn-floating-save').classList.remove('visible'); updateHistoryBtns(); }, 50);
        }
        window.saveEditorImage = () => { imageStore[currentEditingUploadId]=editHistory[historyIndex]; renderImageBox(currentEditingUploadId, editHistory[historyIndex]); window.closeEditor(); };
        window.closeEditor = () => { document.getElementById('image-editor-modal').style.display='none'; unlockZoom(); if(currentEditorCropper) currentEditorCropper.destroy(); };
        window.resetView = () => reloadEditorState(editHistory[0]);
        function updateHistoryBtns() { document.getElementById('btn-undo').disabled=historyIndex<=0; document.getElementById('btn-redo').disabled=historyIndex>=editHistory.length-1; }
        function lockZoom() { document.querySelector('#viewport-meta').setAttribute('content','width=1280, user-scalable=no, initial-scale=1.0, maximum-scale=1.0'); }
        function unlockZoom() { document.querySelector('#viewport-meta').setAttribute('content','width=1280, user-scalable=yes'); }
        function preloadImagesSmartly() { let imgs=[]; Object.values(imageDataBase).forEach(a=>imgs=[...imgs,...a]); let c=0; const load=()=>{if(c<imgs.length){new Image().src=imgs[c++]; load();}}; load();load(); }
        function updateProgress() {
            let c=0; const n=document.getElementById('input-fullName'); if(n.value.trim() && validateName(n.value).valid) c++;
            ['sashType','capType','gownType'].forEach(id => { if(document.getElementById(id).value) c++; });
            document.getElementById('progress-bar').style.width = `${c*25}%`; document.getElementById('progress-text').innerText = c===4?"مكتمل":"قيد التعبئة";
        }

        // --- الارسال والتوليد ---
        window.initiateSendProcess = async () => {
            const nameInp = document.querySelector('[name="fullName"]'); window.cleanNameInput(nameInp);
            const name = nameInp.value, valid = validateName(name);
            if(!name || !valid.valid) return Swal.fire('خطأ', 'يرجى كتابة الاسم الرباعي بشكل صحيح', 'error');
            const conf = await Swal.fire({ title: 'تأكيد', text: 'هل تود الإرسال؟', icon: 'question', showCancelButton: true, confirmButtonText: 'نعم', cancelButtonText: 'لا' });
            if(!conf.isConfirmed) return;
            
            document.getElementById('loading-overlay').style.display='flex';
            try {
                const check = await (await fetch(SCRIPT_URL, {method:'POST', body:JSON.stringify({action:'check', name})})).json();
                document.getElementById('loading-overlay').style.display='none';
                if(check.exists) {
                    Swal.fire({ title:'مسجل مسبقاً', text:'هل تريد الاستبدال أم حجز جديد؟', showDenyButton:true, showCancelButton:true, confirmButtonText:'استبدال', denyButtonText:'جديد' })
                    .then(r => { if(r.isConfirmed) finalize(name, 'replace'); else if(r.isDenied) finalize(name, 'second'); });
                } else finalize(name, 'new');
            } catch(e) { document.getElementById('loading-overlay').style.display='none'; finalize(name, 'new'); }
        };

        async function finalize(name, type) {
            document.getElementById('loading-overlay').style.display='flex';
            const suffix = new Date().getTime().toString().slice(-4), html = generateExactStaticHTML(name);
            const fn = type==='replace' ? `${name} (أعادة).html` : (type==='second' ? `${name} (2)_${suffix}.html` : `${name}_${suffix}.html`);
            try {
                const res = await (await fetch(SCRIPT_URL, {method:'POST', body:JSON.stringify({action:type==='second'?'new':type, rawName:name, filename:fn, html})})).json();
                document.getElementById('loading-overlay').style.display='none';
                if(res.result==='success') Swal.fire('نجاح', 'تم استلام الطلب', 'success').then(()=>location.reload());
                else throw new Error('Error');
            } catch(e) { document.getElementById('loading-overlay').style.display='none'; Swal.fire('خطأ', 'فشل الارسال', 'error'); }
        }

        function generateExactStaticHTML(name) {
            const c = document.getElementById('main-form-container').cloneNode(true);
            const origs = document.getElementById('main-form-container').querySelectorAll('input, textarea, select');
            const clones = c.querySelectorAll('input, textarea, select');
            
            origs.forEach((o, i) => {
                const cl = clones[i];
                let val = o.value; if(!val.trim()) { val="ــــــــ"; cl.style.color="#9ca3af"; } else cl.style.color="#000";
                if(o.tagName==='TEXTAREA') cl.textContent=val; else cl.setAttribute('value', val);
                if(o.type==='checkbox'||o.type==='radio') { if(o.checked) cl.setAttribute('checked','checked'); }
                cl.setAttribute('readonly','true'); cl.classList.add('pointer-events-none','bg-white'); cl.classList.remove('border-red-400','border-green-500'); cl.classList.add('border-gray-300');
            });
            
            c.querySelectorAll('.hidden, .img-actions, input[type="file"], .help-btn, #name-warning-msg').forEach(e => e.remove());
            c.querySelectorAll('*').forEach(e => { e.removeAttribute('onclick'); e.removeAttribute('onchange'); e.removeAttribute('oninput'); e.style.pointerEvents='none'; });
            
            c.querySelectorAll('.upload-box').forEach(b => {
                if(!b.classList.contains('has-image')) {
                    b.innerHTML = `<div class="flex flex-col items-center justify-center opacity-70"><i class="fas fa-image-slash mb-2" style="font-size:4rem"></i><span>لم يتم ارفاق صورة</span></div>`;
                    b.style.background="#f8fafc"; b.style.borderColor="#e2e8f0";
                } else b.style.borderStyle='solid';
            });

            return `<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="UTF-8"><meta name="viewport" content="width=1280"><title>استمارة ${name}</title>
            <script src="https://cdn.tailwindcss.com"><\/script><link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@500;700;800;900&display=swap" rel="stylesheet"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
            <style>body{font-family:'Tajawal';background:#f1f5f9;width:1280px;margin:0 auto;padding-bottom:50px} header{background:white;padding:20px;border-bottom:8px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center} .swal2-container{display:none!important}</style>
            </head><body class="bg-gray-50"><header><h1 class="text-4xl font-black text-gray-900">استمارة الطالب: ${name}</h1><span class="text-2xl font-black text-blue-800 bg-blue-100 px-6 py-2 rounded-full">نسخة للعرض</span></header>
            ${c.innerHTML}
            <footer class="text-center py-12 text-gray-600 text-2xl font-black border-t-8 border-gray-200 mt-10">تم الحفظ بتاريخ ${new Date().toLocaleDateString('ar-EG')}</footer></body></html>`;
        }
    </script>
</body>
</html>