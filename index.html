<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1280, user-scalable=yes">
    <title>استمارة التخرج - النسخة المحمية</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        /* --- إعدادات الصفحة الأساسية --- */
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #f1f5f9;
            min-width: 1280px;
            position: relative;
            min-height: 100vh;
        }

        .swal2-container {
            position: absolute !important;
            width: 100% !important;
            min-width: 1280px !important;
            height: 100% !important;
            top: 0 !important; left: 0 !important;
            display: flex !important;
            align-items: center !important; justify-content: center !important;
            z-index: 99999 !important;
        }

        .option-card {
            cursor: pointer;
            border: 1px solid #cbd5e1;
            border-radius: 0.75rem;
            padding: 0.75rem;
            font-size: 0.9rem;
            transition: all 0.2s ease-in-out;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; background-color: white;
            min-height: 60px; font-weight: 600; color: #475569;
            position: relative;
        }
        .option-card:hover { border-color: #94a3b8; transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }

        /* Active States */
        .option-card.active-purple { background-color: #f3e8ff; border-color: #9333ea; color: #6b21a8; box-shadow: 0 0 0 2px #9333ea; }
        .option-card.active-indigo { background-color: #e0e7ff; border-color: #4f46e5; color: #3730a3; box-shadow: 0 0 0 2px #4f46e5; }
        .option-card.active-emerald { background-color: #d1fae5; border-color: #059669; color: #065f46; box-shadow: 0 0 0 2px #059669; }
        .option-card.active-gray { background-color: #f3f4f6; border-color: #6b7280; color: #374151; box-shadow: 0 0 0 2px #9ca3af; }

        /* Upload Boxes */
        .upload-container-wrapper { width: 100%; max-width: 350px; margin: 0 auto; }
        .upload-box {
            width: 100%; aspect-ratio: 1 / 1;
            border: 2px dashed #cbd5e1; border-radius: 0.75rem;
            position: relative; background-color: #f8fafc;
            transition: all 0.3s ease; overflow: hidden;
            display: flex; align-items: center; justify-content: center;
        }
        .upload-box:hover { border-color: #3b82f6; background-color: #eff6ff; }
        .upload-box.has-image { border-style: solid; border-color: #e2e8f0; background-color: #fff; }
        .upload-placeholder { text-align: center; color: #94a3b8; pointer-events: none; padding: 1rem; }
        .uploaded-img { width: 100%; height: 100%; object-fit: contain; display: block; }

        .img-actions {
            position: absolute; top: 5px; right: 5px;
            display: flex; gap: 5px; opacity: 0; transition: opacity 0.2s; z-index: 10;
        }
        .upload-box:hover .img-actions { opacity: 1; }
        .action-btn {
            width: 24px; height: 24px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.7rem; color: white; border: none; cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .custom-input { transition: all 0.2s; }
        .custom-input:focus { transform: translateY(-1px); }
        .hidden { display: none !important; }
        
        /* Loading */
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95); z-index: 9999;
            display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center;
        }
        .loader {
            border: 5px solid #f3f3f3; border-top: 5px solid #3b82f6;
            border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        #loading-text { font-size: 1.2rem; font-weight: bold; color: #1e293b; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Subsections */
        .subsection-title {
            display: flex; align-items: center; gap: 0.5rem;
            font-size: 1rem; font-weight: 700; margin-bottom: 1rem;
            padding-bottom: 0.5rem; border-bottom: 2px solid #f1f5f9;
        }
        .subsection-container {
            background-color: #ffffff; border: 1px solid #e2e8f0;
            border-radius: 0.75rem; padding: 1.25rem; margin-bottom: 1rem;
        }
        .inner-subtitle {
            font-size: 0.9rem; font-weight: 800; margin-bottom: 1rem;
            display: inline-block; border-right: 4px solid; padding-right: 8px;
        }
        @media print { .no-print { display: none !important; } }
    </style>
</head>
<body class="min-h-screen pb-24">

    <div id="loading-overlay">
        <div class="loader"></div>
        <h3 id="loading-text" class="text-xl font-bold text-gray-800">جاري المعالجة...</h3>
    </div>

    <header class="bg-white shadow-sm sticky top-0 z-40 no-print border-b border-gray-100">
        <div class="max-w-4xl mx-auto px-4 py-3 flex flex-col md:flex-row justify-between items-center gap-3">
            <h1 class="text-lg font-bold text-gray-800">استمارة زي التخرج الذكية</h1>
            <div class="w-full md:w-1/2 flex flex-col items-center">
                <div class="w-full bg-gray-100 rounded-full h-3 overflow-hidden shadow-inner">
                    <div id="progress-bar" class="bg-gradient-to-l from-blue-500 to-blue-600 h-3 rounded-full transition-all duration-700 ease-out" style="width: 0%"></div>
                </div>
                <span id="progress-text" class="text-xs font-bold text-blue-600 mt-1">جاري البدء...</span>
            </div>
        </div>
    </header>

    <main id="main-form-container" class="max-w-4xl mx-auto mt-6 px-4 space-y-6">
        <form id="gradForm" onsubmit="return false;">

            <!-- Info Section -->
            <section class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 relative overflow-hidden">
                <div class="absolute top-0 right-0 w-1.5 h-full bg-blue-500"></div>
                <h2 class="text-xl font-bold mb-6 text-gray-800 flex items-center gap-2">
                    <i class="fas fa-user-graduate text-blue-500 bg-blue-50 p-2 rounded-lg"></i> قسم المعلومات
                </h2>
                <div class="w-full">
                    <label class="block text-gray-700 font-bold mb-2 text-sm">الاسم الرباعي (إجباري)</label>
                    <input type="text" name="fullName" id="input-fullName" class="custom-input w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none bg-gray-50 text-xl font-bold" placeholder="اكتب اسمك الرباعي كاملاً..." required oninput="updateProgress()">
                    <!-- تم إضافة ID هنا لسهولة الحذف لاحقاً -->
                    <p id="name-warning-msg" class="text-xs text-red-500 mt-1 mr-1 font-bold"><i class="fas fa-exclamation-circle ml-1"></i> تنبيه: يجب كتابة الاسم مكوناً من 4 مقاطع على الأقل لضمان عدم تشابه الأسماء.</p>
                </div>
            </section>

            <!-- Sash Section -->
            <section class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 relative overflow-hidden">
                <div class="absolute top-0 right-0 w-1.5 h-full bg-purple-500"></div>
                <h2 class="text-xl font-bold mb-6 text-gray-800 flex items-center gap-2">
                    <i class="fas fa-ribbon text-purple-500 bg-purple-50 p-2 rounded-lg"></i> أولاً: الوشاح
                </h2>

                <div class="subsection-container border-purple-100">
                    <h3 class="subsection-title text-purple-800">
                        <span class="bg-purple-100 text-purple-600 rounded-full w-6 h-6 flex items-center justify-center text-xs ml-2">1</span>
                        نوع الوشاح
                    </h3>
                    <input type="hidden" id="sashType" name="sashType" onchange="handleSashChange()">
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                        <div class="option-card hover:bg-purple-50" onclick="selectOption('sashType', 'عادي', this, 'purple')">عادي</div>
                        <div class="option-card hover:bg-purple-50" onclick="selectOption('sashType', 'مثلث', this, 'purple')">مثلث</div>
                        <div class="option-card hover:bg-purple-50" onclick="selectOption('sashType', 'ملكي فرعوني', this, 'purple')">ملكي فرعوني</div>
                        <div class="option-card hover:bg-purple-50" onclick="selectOption('sashType', 'ملكي مثلث', this, 'purple')">ملكي مثلث</div>
                        <div class="option-card hover:bg-purple-50" onclick="selectOption('sashType', 'جانبي', this, 'purple')">جانبي</div>
                        <div class="option-card hover:bg-purple-50" onclick="selectOption('sashType', 'امريكي + عادي', this, 'purple')">امريكي + عادي</div>
                        <div class="option-card hover:bg-purple-50" onclick="selectOption('sashType', 'امريكي + مثلث', this, 'purple')">امريكي + مثلث</div>
                        <div class="option-card hover:bg-purple-50" onclick="selectOption('sashType', 'امريكي + ملكي فرعوني', this, 'purple')">امريكي + ملكي فرعوني</div>
                        <div class="option-card hover:bg-purple-50" onclick="selectOption('sashType', 'امريكي + ملكي مثلث', this, 'purple')">امريكي + ملكي مثلث</div>
                        <div class="option-card hover:bg-purple-50" onclick="selectOption('sashType', 'امريكي + جانبي', this, 'purple')">امريكي + جانبي</div>
                        <div class="option-card hover:bg-red-50 col-span-2 sm:col-span-2" onclick="selectOption('sashType', 'لا اريد وشاح', this, 'gray')">
                            <span class="text-red-500 font-bold">لا اريد وشاح</span>
                        </div>
                    </div>
                </div>

                <div id="sashContentWrapper" class="hidden space-y-4">
                    <div class="subsection-container border-purple-100 bg-purple-50/30">
                        <h3 class="subsection-title text-purple-800">
                            <span class="bg-purple-100 text-purple-600 rounded-full w-6 h-6 flex items-center justify-center text-xs ml-2">2</span>
                            النقش على الوشاح
                        </h3>
                        <div class="mb-4">
                            <h4 class="inner-subtitle text-purple-700 border-purple-400">النقش من الامام</h4>
                            <div id="sashSectionTwoSides" class="hidden">
                                <div class="grid grid-cols-2 gap-4 justify-items-center">
                                    <div class="upload-container-wrapper">
                                        <label class="block text-xs font-bold text-gray-500 mb-2 text-center">الجهة اليمنى</label>
                                        <div id="upload-sash-right"></div>
                                        <textarea name="sashRightText" class="mt-2 w-full p-2 border border-gray-300 rounded-lg text-xl font-bold focus:ring-1 focus:ring-purple-500 outline-none resize-none bg-white placeholder-gray-400" rows="3" placeholder="أو اكتب وصف النقش هنا..."></textarea>
                                    </div>
                                    <div class="upload-container-wrapper">
                                        <label class="block text-xs font-bold text-gray-500 mb-2 text-center">الجهة اليسرى</label>
                                        <div id="upload-sash-left"></div>
                                        <textarea name="sashLeftText" class="mt-2 w-full p-2 border border-gray-300 rounded-lg text-xl font-bold focus:ring-1 focus:ring-purple-500 outline-none resize-none bg-white placeholder-gray-400" rows="3" placeholder="أو اكتب وصف النقش هنا..."></textarea>
                                    </div>
                                </div>
                            </div>
                            <div id="sashSectionOneSide" class="hidden">
                                <div class="flex justify-center">
                                    <div class="upload-container-wrapper">
                                        <label class="block text-xs font-bold text-gray-500 mb-2 text-center">صورة النقش</label>
                                        <div id="upload-sash-side-1"></div>
                                        <textarea name="sashSideText" class="mt-2 w-full p-2 border border-gray-300 rounded-lg text-xl font-bold focus:ring-1 focus:ring-purple-500 outline-none resize-none bg-white placeholder-gray-400" rows="3" placeholder="أو اكتب وصف النقش هنا..."></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="sashSectionBack" class="hidden pt-4 border-t border-purple-200/60">
                            <h4 class="inner-subtitle text-purple-700 border-purple-400">النقش من الخلف (خاص بالوشاح الملكي)</h4>
                             <div class="grid grid-cols-2 gap-4 justify-items-center">
                                <div class="upload-container-wrapper">
                                    <div id="upload-sash-back-1"></div>
                                    <textarea name="sashBack1Text" class="mt-2 w-full p-2 border border-gray-300 rounded-lg text-xl font-bold focus:ring-1 focus:ring-purple-500 outline-none resize-none bg-white placeholder-gray-400" rows="3" placeholder="أو اكتب وصف النقش هنا..."></textarea>
                                </div>
                                <div class="upload-container-wrapper">
                                    <div id="upload-sash-back-2"></div>
                                    <textarea name="sashBack2Text" class="mt-2 w-full p-2 border border-gray-300 rounded-lg text-xl font-bold focus:ring-1 focus:ring-purple-500 outline-none resize-none bg-white placeholder-gray-400" rows="3" placeholder="أو اكتب وصف النقش هنا..."></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="subsection-container border-purple-100">
                        <h3 class="subsection-title text-purple-800">
                            <span class="bg-purple-100 text-purple-600 rounded-full w-6 h-6 flex items-center justify-center text-xs ml-2">3</span>
                            تنسيق الالوان
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-gray-600 text-xs font-bold mb-1">لون الوشاح</label>
                                <input type="text" name="sashColor" class="custom-input w-full p-2.5 border border-gray-300 rounded-lg text-xl font-bold bg-gray-50" placeholder="مثلا: ماروني">
                            </div>
                            <div>
                                <label class="block text-gray-600 text-xs font-bold mb-1">لون الكركوشة</label>
                                <input type="text" name="sashTasselColor" class="custom-input w-full p-2.5 border border-gray-300 rounded-lg text-xl font-bold bg-gray-50" placeholder="مثلا: ذهبي">
                            </div>
                            <div>
                                <label class="block text-gray-600 text-xs font-bold mb-1">لون النقش</label>
                                <input type="text" name="sashEmbroideryColor" class="custom-input w-full p-2.5 border border-gray-300 rounded-lg text-xl font-bold bg-gray-50" placeholder="مثلا: أبيض">
                            </div>
                        </div>
                    </div>
                    <div class="subsection-container border-purple-100">
                        <h3 class="subsection-title text-purple-800">
                            <span class="bg-purple-100 text-purple-600 rounded-full w-6 h-6 flex items-center justify-center text-xs ml-2">4</span>
                            ملاحظات اظافية
                        </h3>
                        <div class="flex flex-col md:flex-row gap-4 items-stretch">
                            <div class="flex-1">
                                <textarea name="sashNotes" class="custom-input w-full h-full min-h-[180px] p-3 border border-gray-300 rounded-xl text-xl font-bold resize-none shadow-sm focus:border-purple-400 bg-gray-50" placeholder="اكتب أي تفاصيل إضافية هنا..."></textarea>
                            </div>
                            <div class="w-full md:w-[350px] flex-shrink-0 flex flex-col">
                                <label class="block text-purple-700 text-xs font-bold mb-2 text-center">صورة توضيحية (اختياري)</label>
                                <div class="upload-container-wrapper w-full">
                                    <div id="upload-sash-notes"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Cap Section -->
            <section class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 relative overflow-hidden">
                <div class="absolute top-0 right-0 w-1.5 h-full bg-indigo-500"></div>
                <h2 class="text-xl font-bold mb-6 text-gray-800 flex items-center gap-2">
                    <i class="fas fa-graduation-cap text-indigo-500 bg-indigo-50 p-2 rounded-lg"></i> ثانياً: القبعة
                </h2>
                <div class="subsection-container border-indigo-100">
                    <h3 class="subsection-title text-indigo-800">
                        <span class="bg-indigo-100 text-indigo-600 rounded-full w-6 h-6 flex items-center justify-center text-xs ml-2">1</span>
                        نوع القبعة
                    </h3>
                    <input type="hidden" id="capType" name="capType" onchange="handleCapTypeChange()">
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                        <div class="option-card hover:bg-indigo-50" onclick="selectOption('capType', 'قبعة عادية', this, 'indigo')">   قبعة دائرية عدلة (عادية)   </div>
                        <div class="option-card hover:bg-indigo-50" onclick="selectOption('capType', 'قبعة ملكية', this, 'indigo')">قبعة مثلث (ملكية)</div>
                        <div class="option-card hover:bg-red-50" onclick="selectOption('capType', 'لا اريد قبعة', this, 'gray')">
                            <span class="text-red-500 font-bold">لا اريد قبعة</span>
                        </div>
                    </div>
                </div>
                <div id="capContentWrapper" class="hidden space-y-4">
                    <div class="subsection-container border-indigo-100 bg-indigo-50/30">
                        <h3 class="subsection-title text-indigo-800">
                            <span class="bg-indigo-100 text-indigo-600 rounded-full w-6 h-6 flex items-center justify-center text-xs ml-2">2</span>
                            النقش على القبعة
                        </h3>
                        <div class="mb-4">
                            <label class="block text-gray-600 text-xs font-bold mb-2 text-center">حدد مكان النقش أولاً</label>
                            <input type="hidden" id="capEmbroideryLoc" name="capEmbroideryLoc" onchange="handleCapEmbroideryChange()">
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                                <div class="option-card text-sm py-2 min-h-[40px] hover:bg-indigo-50" onclick="selectOption('capEmbroideryLoc', 'فوق القبعة', this, 'indigo')">فوق القبعة</div>
                                <div class="option-card text-sm py-2 min-h-[40px] hover:bg-indigo-50" onclick="selectOption('capEmbroideryLoc', 'طوق القبعة', this, 'indigo')">طوق القبعة</div>
                                <div class="option-card text-sm py-2 min-h-[40px] hover:bg-indigo-50" onclick="selectOption('capEmbroideryLoc', 'دبل نقش', this, 'indigo')">دبل نقش</div>
                                <div class="option-card text-sm py-2 min-h-[40px] hover:bg-red-50" onclick="selectOption('capEmbroideryLoc', 'لا اريد نقش', this, 'gray')">لا اريد نقش</div>
                            </div>
                        </div>
                        <div class="flex flex-col md:flex-row gap-4 justify-center">
                            <div id="capSectionTop" class="hidden w-full md:w-1/2 p-3 rounded-lg border border-indigo-100 bg-white">
                                <h3 class="font-bold text-xs text-indigo-800 mb-2 text-center">صورة النقش (فوق القبعة)</h3>
                                <div class="upload-container-wrapper">
                                    <div id="upload-cap-top"></div>
                                    <textarea name="capTopText" class="mt-2 w-full p-2 border border-gray-300 rounded-lg text-xl font-bold focus:ring-1 focus:ring-indigo-500 outline-none resize-none bg-white placeholder-gray-400" rows="3" placeholder="أو اكتب وصف النقش هنا..."></textarea>
                                </div>
                            </div>
                            <div id="capSectionRim" class="hidden w-full md:w-1/2 p-3 rounded-lg border border-indigo-100 bg-white">
                                <h3 class="font-bold text-xs text-indigo-800 mb-2 text-center">صورة النقش (طوق القبعة)</h3>
                                <div class="upload-container-wrapper">
                                    <div id="upload-cap-rim"></div>
                                    <textarea name="capRimText" class="mt-2 w-full p-2 border border-gray-300 rounded-lg text-xl font-bold focus:ring-1 focus:ring-indigo-500 outline-none resize-none bg-white placeholder-gray-400" rows="3" placeholder="أو اكتب وصف النقش هنا..."></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="subsection-container border-indigo-100">
                        <h3 class="subsection-title text-indigo-800">
                            <span class="bg-indigo-100 text-indigo-600 rounded-full w-6 h-6 flex items-center justify-center text-xs ml-2">3</span>
                            تنسيق الالوان
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-gray-600 text-xs font-bold mb-1">لون القبعة</label>
                                <input type="text" name="capColor" class="custom-input w-full p-2.5 border border-gray-300 rounded-lg text-xl font-bold bg-gray-50" placeholder="مثلا: أسود">
                            </div>
                            <div id="capEmbroideryColorField">
                                <label class="block text-gray-600 text-xs font-bold mb-1">لون النقش</label>
                                <input type="text" name="capEmbroideryColor" class="custom-input w-full p-2.5 border border-gray-300 rounded-lg text-xl font-bold bg-gray-50" placeholder="مثلا: ذهبي">
                            </div>
                            <div>
                                <label class="block text-gray-600 text-xs font-bold mb-1">لون الكركوشة</label>
                                <input type="text" name="capTasselColor" class="custom-input w-full p-2.5 border border-gray-300 rounded-lg text-xl font-bold bg-gray-50" placeholder="مثلا: أصفر">
                            </div>
                        </div>
                    </div>
                    <div class="subsection-container border-indigo-100">
                        <h3 class="subsection-title text-indigo-800">
                            <span class="bg-indigo-100 text-indigo-600 rounded-full w-6 h-6 flex items-center justify-center text-xs ml-2">4</span>
                            ملاحظات اظافية
                        </h3>
                         <div class="flex flex-col md:flex-row gap-4 items-stretch">
                            <div class="flex-1">
                                <textarea name="capNotes" class="custom-input w-full h-full min-h-[180px] p-3 border border-gray-300 rounded-xl text-xl font-bold resize-none shadow-sm focus:border-indigo-400 bg-gray-50" placeholder="اكتب أي تفاصيل إضافية هنا..."></textarea>
                            </div>
                            <div class="w-full md:w-[350px] flex-shrink-0 flex flex-col">
                                <label class="block text-indigo-700 text-xs font-bold mb-2 text-center">صورة توضيحية (اختياري)</label>
                                <div class="upload-container-wrapper w-full">
                                    <div id="upload-cap-notes"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Gown Section -->
            <section class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 relative overflow-hidden">
                 <div class="absolute top-0 right-0 w-1.5 h-full bg-emerald-500"></div>
                <h2 class="text-xl font-bold mb-6 text-gray-800 flex items-center gap-2">
                    <i class="fas fa-tshirt text-emerald-500 bg-emerald-50 p-2 rounded-lg"></i> ثالثاً: الروب
                </h2>
                <div class="subsection-container border-emerald-100">
                    <h3 class="subsection-title text-emerald-800">
                        <span class="bg-emerald-100 text-emerald-600 rounded-full w-6 h-6 flex items-center justify-center text-xs ml-2">1</span>
                        نوع الروب
                    </h3>
                    <input type="hidden" id="gownType" name="gownType" onchange="handleGownChange()">
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                        <div class="option-card hover:bg-emerald-50" onclick="selectOption('gownType', 'روب خليجي', this, 'emerald')">روب خليجي</div>
                        <div class="option-card hover:bg-emerald-50" onclick="selectOption('gownType', 'روب امريكي', this, 'emerald')">روب امريكي</div>
                        <div class="option-card hover:bg-red-50" onclick="selectOption('gownType', 'لا اريد روب', this, 'gray')">
                            <span class="text-red-500 font-bold">لا اريد روب</span>
                        </div>
                    </div>
                </div>
                <div id="gownContentWrapper" class="hidden space-y-4">
                    <div class="subsection-container border-emerald-100">
                        <h3 class="subsection-title text-emerald-800">
                            <span class="bg-emerald-100 text-emerald-600 rounded-full w-6 h-6 flex items-center justify-center text-xs ml-2">2</span>
                            تنسيق الالوان
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-gray-600 text-xs font-bold mb-1">لون الروب</label>
                                <input type="text" name="gownColor" class="custom-input w-full p-2.5 border border-gray-300 rounded-lg text-xl font-bold bg-gray-50" placeholder="مثلا: أسود">
                            </div>
                        </div>
                    </div>
                    <div class="subsection-container border-emerald-100">
                        <h3 class="subsection-title text-emerald-800">
                            <span class="bg-emerald-100 text-emerald-600 rounded-full w-6 h-6 flex items-center justify-center text-xs ml-2">3</span>
                            ملاحظات اظافية
                        </h3>
                         <div class="flex flex-col md:flex-row gap-4 items-stretch">
                            <div class="flex-1">
                                <textarea name="gownNotes" class="custom-input w-full h-full min-h-[180px] p-3 border border-gray-300 rounded-xl text-xl font-bold resize-none shadow-sm focus:border-emerald-400 bg-gray-50" placeholder="اكتب أي تفاصيل إضافية هنا..."></textarea>
                            </div>
                            <div class="w-full md:w-[350px] flex-shrink-0 flex flex-col">
                                <label class="block text-emerald-700 text-xs font-bold mb-2 text-center">صورة توضيحية (اختياري)</label>
                                <div class="upload-container-wrapper w-full">
                                    <div id="upload-gown-notes"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <div class="w-full flex justify-center py-8 no-print mt-8 border-t border-gray-200">
                <button onclick="initiateSendProcess()" class="w-full md:w-1/2 p-4 bg-green-600 text-white rounded-full shadow-xl hover:bg-green-700 transition transform hover:scale-105 flex items-center justify-center gap-2 font-bold text-lg ring-4 ring-green-200 group">
                    <span class="group-hover:animate-pulse"><i class="fas fa-paper-plane text-xl ml-2"></i></span>
                    إرسال واعتماد الطلب
                </button>
            </div>

        </form>
    </main>

    <script>
        // ==================================================================
        // رابط السكربت (تأكد من تحديثه إذا قمت بعمل Deploy جديد)
        // ==================================================================
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxp_GUP-5YMOVMxQKjTVL65CYPKqLB3r6b3f_wAAGRXvJUiSsmUoVKF3AfTco95bdp6Jg/exec"; 
        // ==================================================================

        const uploadIDs = [
            'upload-sash-right', 'upload-sash-left', 'upload-sash-back-1', 'upload-sash-back-2',
            'upload-sash-side-1', 'upload-sash-notes', 
            'upload-cap-top', 'upload-cap-rim', 'upload-cap-notes', 
            'upload-gown-notes'
        ];
        
        const imageStore = {};

        document.addEventListener('DOMContentLoaded', () => {
            initUploadBoxes();
            updateProgress();
        });

        function isValidQuadrupleName(name) {
            if (!name) return false;
            const parts = name.trim().split(/\s+/).filter(part => part.length > 0);
            return parts.length >= 4;
        }

        function normalizeArabicName(name) {
            if (!name) return "";
            return name.trim()
                .replace(/[أإآ]/g, 'ا')  
                .replace(/ة/g, 'ه')      
                .replace(/ى/g, 'ي')      
                .replace(/\s+/g, ' ');   
        }

        function selectOption(inputId, value, element, theme) {
            const input = document.getElementById(inputId);
            input.value = value;
            const parent = element.parentElement;
            parent.querySelectorAll('.option-card').forEach(c => {
                c.classList.remove('active-purple', 'active-indigo', 'active-emerald', 'active-gray');
            });
            element.classList.add(`active-${theme}`);
            input.dispatchEvent(new Event('change'));
            updateProgress();
        }

        function handleSashChange() {
            const val = document.getElementById('sashType').value;
            const wrapper = document.getElementById('sashContentWrapper');
            if (!val || val.includes('لا اريد')) { wrapper.classList.add('hidden'); updateProgress(); return; }
            wrapper.classList.remove('hidden');
            if (val.includes('جانبي')) {
                document.getElementById('sashSectionTwoSides').classList.add('hidden');
                document.getElementById('sashSectionOneSide').classList.remove('hidden');
            } else {
                document.getElementById('sashSectionTwoSides').classList.remove('hidden');
                document.getElementById('sashSectionOneSide').classList.add('hidden');
            }
            if (val.includes('ملكي')) {
                document.getElementById('sashSectionBack').classList.remove('hidden');
            } else {
                document.getElementById('sashSectionBack').classList.add('hidden');
            }
            updateProgress();
        }

        function handleCapTypeChange() {
            const val = document.getElementById('capType').value;
            const wrapper = document.getElementById('capContentWrapper');
            val && !val.includes('لا اريد') ? wrapper.classList.remove('hidden') : wrapper.classList.add('hidden');
            updateProgress();
        }

        function handleCapEmbroideryChange() {
            const loc = document.getElementById('capEmbroideryLoc').value;
            const top = document.getElementById('capSectionTop');
            const rim = document.getElementById('capSectionRim');
            const colorField = document.getElementById('capEmbroideryColorField');
            top.classList.add('hidden'); rim.classList.add('hidden'); colorField.classList.remove('hidden');
            if (loc === 'فوق القبعة') top.classList.remove('hidden');
            else if (loc === 'طوق القبعة') rim.classList.remove('hidden');
            else if (loc.includes('دبل')) { top.classList.remove('hidden'); rim.classList.remove('hidden'); }
            else if (loc.includes('لا اريد')) colorField.classList.add('hidden');
        }

        function handleGownChange() {
            const val = document.getElementById('gownType').value;
            const wrapper = document.getElementById('gownContentWrapper');
            val && !val.includes('لا اريد') ? wrapper.classList.remove('hidden') : wrapper.classList.add('hidden');
            updateProgress();
        }

        function initUploadBoxes() {
            uploadIDs.forEach(id => {
                const container = document.getElementById(id);
                if(container && !container.querySelector('.upload-box')) renderEmptyBox(id);
            });
        }

        function renderEmptyBox(id) {
            const container = document.getElementById(id);
            container.innerHTML = `
                <div class="upload-box group" onclick="document.getElementById('file-${id}').click()">
                    <input type="file" id="file-${id}" class="hidden" accept="image/*" onchange="processFile(event, '${id}')">
                    <div class="upload-placeholder">
                        <i class="fas fa-cloud-upload-alt text-xl text-blue-200 group-hover:text-blue-500 transition mb-2"></i>
                        <span class="text-[10px] font-bold text-gray-400 block">صورة</span>
                    </div>
                </div>`;
        }

        function renderImageBox(id, base64) {
            const container = document.getElementById(id);
            container.innerHTML = `
                <div class="upload-box has-image relative">
                    <img src="${base64}" class="uploaded-img">
                    <div class="img-actions">
                        <button onclick="changeImage(event, '${id}')" class="action-btn bg-blue-500"><i class="fas fa-pen"></i></button>
                        <button onclick="removeImage(event, '${id}')" class="action-btn bg-red-500"><i class="fas fa-trash"></i></button>
                    </div>
                    <input type="file" id="file-${id}" class="hidden" accept="image/*" onchange="processFile(event, '${id}')">
                </div>`;
        }

        function processFile(event, id) {
            const file = event.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                imageStore[id] = e.target.result;
                renderImageBox(id, e.target.result);
            };
            reader.readAsDataURL(file);
        }

        function changeImage(e, id) { e.stopPropagation(); document.getElementById(`file-${id}`).click(); }
        function removeImage(e, id) { e.stopPropagation(); delete imageStore[id]; renderEmptyBox(id); }

        function updateProgress() {
            let completedSections = 0;
            if (document.getElementById('input-fullName').value.trim().length > 0) completedSections++;
            if (document.getElementById('sashType').value) completedSections++;
            if (document.getElementById('capType').value) completedSections++;
            if (document.getElementById('gownType').value) completedSections++;
            document.getElementById('progress-bar').style.width = `${(completedSections / 4) * 100}%`;
            document.getElementById('progress-text').innerText = completedSections === 4 ? "مكتمل" : `قيد التعبئة`;
        }

        function showLoading(show, text = "جاري المعالجة...") {
            const overlay = document.getElementById('loading-overlay');
            const loadingText = document.getElementById('loading-text');
            loadingText.innerText = text;
            overlay.style.display = show ? 'flex' : 'none';
        }

        async function initiateSendProcess() {
            const fullNameInput = document.querySelector('[name="fullName"]');
            const fullName = fullNameInput.value.trim();

            if (!fullName) { 
                Swal.fire('خطأ', 'يرجى كتابة الاسم أولاً', 'error'); 
                return; 
            }

            if (!isValidQuadrupleName(fullName)) {
                Swal.fire({
                    title: 'تنبيه هام',
                    text: 'يجب كتابة الاسم الرباعي كاملاً (4 أسماء على الأقل) لضمان دقة التسجيل وتجنب تشابه الأسماء.',
                    icon: 'warning',
                    confirmButtonText: 'حسناً، سأصحح الاسم',
                    confirmButtonColor: '#d97706'
                });
                fullNameInput.focus();
                return; 
            }

            const confirmResult = await Swal.fire({
                title: 'تأكيد الطلب',
                text: `هل أنت متأكد من إرسال البيانات للاسم: ${fullName}؟`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#16a34a',
                cancelButtonColor: '#d33',
                confirmButtonText: 'نعم، تحقق وأرسل',
                cancelButtonText: 'إلغاء'
            });

            if (!confirmResult.isConfirmed) return;

            showLoading(true, "جاري التحقق من السجلات السابقة...");

            try {
                const checkResponse = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'check', name: fullName }) 
                });
                
                const checkData = await checkResponse.json();

                showLoading(false);

                if (checkData.exists) {
                    await Swal.fire({
                        title: 'انت مسجل مسبقاً!',
                        text: 'هناك تسجيلاً سابقاً لك  هل ترغب في استبداله أم حجز جديد؟',
                        icon: 'warning',
                        showDenyButton: true,
                        confirmButtonText: 'استبدال التسجيل القديم',
                        denyButtonText: 'تسجيل وحجز ثاني',
                        confirmButtonColor: '#d97706',
                        denyButtonColor: '#2563eb'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            finalizeSubmission(fullName, 'replace');
                        } else if (result.isDenied) {
                            finalizeSubmission(fullName, 'second');
                        }
                    });
                } else {
                    finalizeSubmission(fullName, 'new');
                }

            } catch (error) {
                showLoading(false);
                console.error(error);
                Swal.fire({
                    title: 'تنبيه',
                    text: 'حدث خطأ في الاتصال. سيتم الحفظ كملف جديد.',
                    icon: 'info',
                    confirmButtonText: 'موافق'
                }).then(() => {
                    finalizeSubmission(fullName, 'new');
                });
            }
        }

        async function finalizeSubmission(fullName, actionType) {
            let loadingMsg = "جاري حفظ الاستمارة...";
            if (actionType === 'replace') loadingMsg = "جاري حذف القديم وحفظ الجديد...";
            
            showLoading(true, loadingMsg);

            let fileName = "";
            const dateStr = new Date().toISOString().split('T')[0];
            const timeSuffix = new Date().getTime().toString().slice(-4);
            
            if (actionType === 'replace') {
                fileName = `${fullName} (أعادة)_${dateStr}.html`; 
            } else if (actionType === 'second') {
                fileName = `${fullName} (2)_${dateStr}_${timeSuffix}.html`;
            } else {
                fileName = `${fullName}_${dateStr}_${timeSuffix}.html`;
            }

            const htmlContent = generateExactStaticHTML(fullName);

            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ 
                        action: actionType === 'second' ? 'new' : actionType, 
                        rawName: fullName,      
                        filename: fileName, 
                        html: htmlContent 
                    })
                });
                
                const data = await response.json();
                showLoading(false);

                if (data.result === 'success') {
                    // =====================================================
                    // استخراج الاسم الأول للرسالة (أول كلمة فقط)
                    // =====================================================
                    const firstName = fullName.trim().split(/\s+/)[0];

                    let msg = "";
                    if (actionType === 'replace') {
                        msg = `تم تسليم طلبك الجديد، شكرًا لك يا ${firstName}.`;
                    } else if (actionType === 'second') {
                        msg = `تم تسليم طلبك الثاني، شكرًا لك يا ${firstName}.`;
                    } else {
                        // تسجيل جديد عادي
                        msg = `تم تسليم طلبك، شكرًا لك يا ${firstName}.`;
                    }
                        
                    Swal.fire('تمت العملية بنجاح!', msg, 'success').then(() => location.reload());
                } else {
                    throw new Error(data.error || 'حدث خطأ غير معروف');
                }
            } catch (error) {
                showLoading(false);
                Swal.fire('خطأ', 'فشل الإرسال، تحقق من الإنترنت', 'error');
            }
        }

        function generateExactStaticHTML(fullName) {
            const originalContainer = document.getElementById('main-form-container');
            const clone = originalContainer.cloneNode(true);
            const originalInputs = originalContainer.querySelectorAll('input, textarea, select');
            const clonedInputs = clone.querySelectorAll('input, textarea, select');

            for (let i = 0; i < originalInputs.length; i++) {
                const orig = originalInputs[i];
                const cln = clonedInputs[i];
                
                cln.removeAttribute('placeholder');

                if (orig.tagName === 'INPUT' || orig.tagName === 'SELECT') {
                    let val = orig.value;
                    if(val.trim() === "") {
                        val = "ــــــــ"; 
                        cln.style.color = "#9ca3af"; 
                    } else {
                        cln.style.color = "#000000"; 
                    }
                    cln.setAttribute('value', val);

                    if (orig.type === 'checkbox' || orig.type === 'radio') {
                        if (orig.checked) cln.setAttribute('checked', 'checked');
                    }
                } else if (orig.tagName === 'TEXTAREA') {
                    let val = orig.value;
                    if(val.trim() === "") {
                        val = "ــــــــ";
                        cln.style.color = "#9ca3af";
                    } else {
                        cln.style.color = "#000000";
                    }
                    cln.textContent = val;
                }
                
                cln.setAttribute('readonly', 'true');
                cln.classList.add('pointer-events-none', 'bg-white'); 
            }

            clone.querySelectorAll('*').forEach(el => {
                el.removeAttribute('onclick'); el.removeAttribute('onchange'); el.removeAttribute('oninput'); el.removeAttribute('onsubmit');
            });
            clone.querySelectorAll('.img-actions').forEach(btn => btn.remove());
            clone.querySelectorAll('input[type="file"]').forEach(inp => inp.remove());
            clone.querySelectorAll('.option-card').forEach(card => { card.style.cursor = 'default'; card.style.pointerEvents = 'none'; });
            
            // حذف رسالة التحذير الخاصة بالاسم الرباعي من النسخة المحفوظة
            const warningMsg = clone.querySelector('#name-warning-msg');
            if (warningMsg) warningMsg.remove();

            clone.querySelectorAll('.upload-box').forEach(box => {
                box.style.pointerEvents = 'none'; 
                box.style.cursor = 'default';
                
                if(box.classList.contains('has-image')) {
                    box.style.borderStyle = 'solid';
                } else {
                    box.innerHTML = `
                        <div class="flex flex-col items-center justify-center text-gray-400 opacity-70">
                            <i class="fas fa-image-slash text-2xl mb-2"></i>
                            <span class="text-[10px] font-bold">لم يتم ارفاق صورة</span>
                        </div>
                    `;
                    box.style.backgroundColor = "#f8fafc";
                    box.style.borderColor = "#e2e8f0";
                }
            });

            let headContent = document.head.innerHTML;
            const desktopViewport = '<meta name="viewport" content="width=1280, user-scalable=yes">';
            if (headContent.includes('<meta name="viewport"')) {
                headContent = headContent.replace(/<meta name="viewport"[^>]*>/gi, desktopViewport);
            } else {
                headContent += desktopViewport;
            }

            return `<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    ${headContent}
    <style>
        body { 
            background-color: #f1f5f9; 
            padding-bottom: 50px; 
            min-width: 1280px; 
        }
        .no-print { display: none !important; }
        input:focus, textarea:focus { outline: none; box-shadow: none; border-color: #e2e8f0; }
        .img-actions { display: none !important; }
        html { overflow-x: auto; }
    </style>
</head>
<body class="min-h-screen bg-gray-50">
    <header class="bg-white shadow-sm sticky top-0 z-40 border-b border-gray-100 mb-6">
        <div class="max-w-4xl mx-auto px-4 py-4 flex justify-between items-center">
             <h1 class="text-lg font-bold text-gray-800">استمارة الطالب: ${fullName}</h1>
             <span class="text-xs font-bold text-blue-600 bg-blue-50 px-3 py-1 rounded-full">نسخة للعرض فقط</span>
        </div>
    </header>
    ${clone.outerHTML}
    <footer class="text-center py-8 text-gray-400 text-xs mt-8 border-t border-gray-200">
        تم حفظ هذه النسخة بتاريخ ${new Date().toLocaleDateString('ar-EG')}
    </footer>
</body>
</html>`;
        }
    </script>
</body>
</html>